!function(serverside,global,$,_,JSON){serverside&&(_=require("underscore"));var reArray=/\[([0-9]*)\](?=\[|\.|$)/g,fieldTemplateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g},valueTemplateSettings={evaluate:/\{\[([\s\S]+?)\]\}/g,interpolate:/\{\{([\s\S]+?)\}\}/g},isSet=function(value){return!(_.isUndefined(value)||_.isNull(value))},jsonform={util:{}},escapeHTML=function(string){return isSet(string)?(string=""+string,string?string.replace(/&(?!\w+;|#\d+;|#x[\da-f]+;)/gi,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):""):""},escapeSelector=function(selector){return selector.replace(/([ \!\"\#\$\%\&\'\(\)\*\+\,\.\/\:\;<\=\>\?\@\[\\\]\^\`\{\|\}\~])/g,"\\$1")},initializeTabs=function(tabs){var activate=function(element,container){container.find("> .active").removeClass("active"),element.addClass("active")},enableFields=function($target,targetIndex){$target.find("input, textarea, select").removeAttr("disabled"),$target.parent().children(":not([data-idx="+targetIndex+"])").find("input, textarea, select").attr("disabled","disabled")},optionSelected=function(e){var $target,$option=$("option:selected",$(this)),$select=$(this),targetIdx=$option.get(0).getAttribute("data-idx")||$option.attr("value");e.preventDefault(),$option.hasClass("active")||($target=$(this).parents(".tabbable").eq(0).find(".tab-content [data-idx="+targetIdx+"]"),activate($option,$select),activate($target,$target.parent()),enableFields($target,targetIdx))},tabClicked=function(e){var $content=($("a",$(this)),$(this).parents(".tabbable").first().find(".tab-content").first()),targetIdx=$(this).index(),$target=$content.find("[data-idx="+targetIdx+"]");e.preventDefault(),activate($(this),$(this).parent()),activate($target,$target.parent()),$(this).parent().hasClass("jsonform-alternative")&&enableFields($target,targetIdx)};tabs.each(function(){$(this).delegate("select.nav","change",optionSelected),$(this).find("select.nav").each(function(){$(this).val($(this).find(".active").attr("value"));var targetIdx=$(this).find("option:selected").get(0).getAttribute("data-idx")||$(this).find("option:selected").attr("value"),$target=$(this).parents(".tabbable").eq(0).find(".tab-content [data-idx="+targetIdx+"]");enableFields($target,targetIdx)}),$(this).delegate("ul.nav li","click",tabClicked),$(this).find("ul.nav li.active").click()})};jsonform.fieldTemplate=function(inner){return'<div class="control-group jsonform-error-<%= keydash %><%= elt.htmlClass ? " " + elt.htmlClass : "" %><%= (node.schemaElement && node.schemaElement.required && (node.schemaElement.type !== "boolean") ? " jsonform-required" : "") %><%= (node.readOnly ? " jsonform-readonly" : "") %><%= (node.disabled ? " jsonform-disabled" : "") %>"><% if (node.title && !elt.notitle) { %><label class="control-label" for="<%= node.id %>"><%= node.title %></label><% } %><div class="controls"><% if (node.prepend || node.append) { %><div class="<% if (node.prepend) { %>input-prepend<% } %><% if (node.append) { %> input-append<% } %>"><% if (node.prepend) { %><span class="add-on"><%= node.prepend %></span><% } %><% } %>'+inner+'<% if (node.append) { %><span class="add-on"><%= node.append %></span><% } %><% if (node.prepend || node.append) { %></div><% } %><% if (node.description) { %><span class="help-inline"><%= node.description %></span><% } %><span class="help-block jsonform-errortext" style="display:none;"></span></div></div>'};var fileDisplayTemplate='<div class="_jsonform-preview"><% if (value.type=="image") { %><img class="jsonform-preview" id="jsonformpreview-<%= id %>" src="<%= value.url %>" /><% } else { %><a href="<%= value.url %>"><%= value.name %></a> (<%= Math.ceil(value.size/1024) %>kB)<% } %></div><a href="#" class="btn _jsonform-delete"><i class="icon-remove" title="Remove"></i></a> ',inputFieldTemplate=function(type){return{template:'<input type="'+type+'" <%= (fieldHtmlClass ? "class=\'" + fieldHtmlClass + "\' " : "") %>name="<%= node.name %>" value="<%= escape(value) %>" id="<%= id %>"<%= (node.disabled? " disabled" : "")%><%= (node.readOnly ? " readonly=\'readonly\'" : "") %><%= (node.schemaElement && node.schemaElement.maxLength ? " maxlength=\'" + node.schemaElement.maxLength + "\'" : "") %><%= (node.schemaElement && node.schemaElement.required && (node.schemaElement.type !== "boolean") ? " required=\'required\'" : "") %><%= (node.placeholder? "placeholder=" + \'"\' + escape(node.placeholder) + \'"\' : "")%> />',fieldtemplate:!0,inputfield:!0}};jsonform.elementTypes={none:{template:""},root:{template:"<div><%= children %></div>"},text:inputFieldTemplate("text"),password:inputFieldTemplate("password"),date:inputFieldTemplate("date"),datetime:inputFieldTemplate("datetime"),"datetime-local":inputFieldTemplate("datetime-local"),email:inputFieldTemplate("email"),month:inputFieldTemplate("month"),number:inputFieldTemplate("number"),search:inputFieldTemplate("search"),tel:inputFieldTemplate("tel"),time:inputFieldTemplate("time"),url:inputFieldTemplate("url"),week:inputFieldTemplate("week"),range:{template:'<input type="range" <%= (fieldHtmlClass ? "class=\'" + fieldHtmlClass + "\' " : "") %>name="<%= node.name %>" value="<%= escape(value) %>" id="<%= id %>"<%= (node.disabled? " disabled" : "")%> min=<%= range.min %> max=<%= range.max %> step=<%= range.step %><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %> />',fieldtemplate:!0,inputfield:!0,onBeforeRender:function(data,node){data.range={min:1,max:100,step:1},node&&node.schemaElement&&(node.formElement&&node.formElement.step&&(data.range.step=node.formElement.step),"undefined"!=typeof node.schemaElement.minimum&&(node.schemaElement.exclusiveMinimum?data.range.min=node.schemaElement.minimum+data.range.step:data.range.min=node.schemaElement.minimum),"undefined"!=typeof node.schemaElement.maximum&&(node.schemaElement.exclusiveMaximum?data.range.max=node.schemaElement.maximum+data.range.step:data.range.max=node.schemaElement.maximum))}},color:{template:'<input type="text" <%= (fieldHtmlClass ? "class=\'" + fieldHtmlClass + "\' " : "") %>name="<%= node.name %>" value="<%= escape(value) %>" id="<%= id %>"<%= (node.disabled? " disabled" : "")%><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %> />',fieldtemplate:!0,inputfield:!0,onInsert:function(evt,node){$(node.el).find("#"+escapeSelector(node.id)).spectrum({preferredFormat:"hex",showInput:!0})}},textarea:{template:'<textarea id="<%= id %>" name="<%= node.name %>" style="height:<%= elt.height || "150px" %>;width:<%= elt.width || "100%" %>;"<%= (node.disabled? " disabled" : "")%><%= (node.readOnly ? " readonly=\'readonly\'" : "") %><%= (node.schemaElement && node.schemaElement.maxLength ? " maxlength=\'" + node.schemaElement.maxLength + "\'" : "") %><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %><%= (node.placeholder? "placeholder=" + \'"\' + escape(node.placeholder) + \'"\' : "")%>><%= value %></textarea>',fieldtemplate:!0,inputfield:!0},wysihtml5:{template:'<textarea id="<%= id %>" name="<%= node.name %>" style="height:<%= elt.height || "300px" %>;width:<%= elt.width || "100%" %>;"<%= (node.disabled? " disabled" : "")%><%= (node.readOnly ? " readonly=\'readonly\'" : "") %><%= (node.schemaElement && node.schemaElement.maxLength ? " maxlength=\'" + node.schemaElement.maxLength + "\'" : "") %><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %><%= (node.placeholder? "placeholder=" + \'"\' + escape(node.placeholder) + \'"\' : "")%>><%= value %></textarea>',fieldtemplate:!0,inputfield:!0,onInsert:function(evt,node){var setup=function(){$(node.el).data("wysihtml5")||($(node.el).data("wysihtml5_loaded",!0),$(node.el).find("#"+escapeSelector(node.id)).wysihtml5({html:!0,link:!0,"font-styles":!0,image:!0,events:{load:function(){$(this.textareaElement).removeAttr("required")}}}))};if(window.jsonform_wysihtml5_setup)return void window.jsonform_wysihtml5_setup(setup);var itv=window.setInterval(function(){window.wysihtml5&&(window.clearInterval(itv),setup())},1e3)}},ace:{template:'<div id="<%= id %>" style="position:relative;height:<%= elt.height || "300px" %>;"><div id="<%= id %>__ace" style="width:<%= elt.width || "100%" %>;height:<%= elt.height || "300px" %>;"></div><input type="hidden" name="<%= node.name %>" id="<%= id %>__hidden" value="<%= escape(value) %>"/></div>',fieldtemplate:!0,inputfield:!0,onInsert:function(evt,node){var setup=function(){var formElement=node.formElement||{},ace=window.ace,editor=ace.edit($(node.el).find("#"+escapeSelector(node.id)+"__ace").get(0)),idSelector="#"+escapeSelector(node.id)+"__hidden";editor.getSession().setNewLineMode("unix"),editor.renderer.setShowPrintMargin(!1),editor.setTheme("ace/theme/"+(formElement.aceTheme||"twilight")),formElement.aceMode&&editor.getSession().setMode("ace/mode/"+formElement.aceMode),editor.getSession().setTabSize(2),editor.getSession().setValue(node.value||"");var lazyChanged=_.debounce(function(){$(node.el).find(idSelector).val(editor.getSession().getValue()),$(node.el).find(idSelector).change()},600);editor.getSession().on("change",lazyChanged),editor.on("blur",function(){$(node.el).find(idSelector).change(),$(node.el).find(idSelector).trigger("blur")}),editor.on("focus",function(){$(node.el).find(idSelector).trigger("focus")})};if(window.jsonform_ace_setup)return void window.jsonform_ace_setup(setup);var itv=window.setInterval(function(){window.ace&&(window.clearInterval(itv),setup())},1e3)}},checkbox:{template:'<label class="checkbox"><input type="checkbox" id="<%= id %>" name="<%= node.name %>" value="1" <% if (value) {%>checked<% } %><%= (node.disabled? " disabled" : "")%><%= (node.schemaElement && node.schemaElement.required && (node.schemaElement.type !== "boolean") ? " required=\'required\'" : "") %> /><span><%= node.inlinetitle || "" %></span></label>',fieldtemplate:!0,inputfield:!0,getElement:function(el){return $(el).parent().get(0)}},file:{template:'<input class="input-file" id="<%= id %>" name="<%= node.name %>" type="file" <%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %>/>',fieldtemplate:!0,inputfield:!0},"file-hosted-public":{template:"<span><% if (value && (value.type||value.url)) { %>"+fileDisplayTemplate+'<% } %><input class="input-file" id="_transloadit_<%= id %>" type="file" name="<%= transloaditname %>" /><input data-transloadit-name="_transloadit_<%= transloaditname %>" type="hidden" id="<%= id %>" name="<%= node.name %>" value=\'<%= escape(JSON.stringify(node.value)) %>\' /></span>',fieldtemplate:!0,inputfield:!0,getElement:function(el){return $(el).parent().get(0)},onBeforeRender:function(data,node){node.ownerTree._transloadit_generic_public_index?node.ownerTree._transloadit_generic_public_index++:node.ownerTree._transloadit_generic_public_index=1,data.transloaditname="_transloadit_jsonform_genericupload_public_"+node.ownerTree._transloadit_generic_public_index,node.ownerTree._transloadit_generic_elts||(node.ownerTree._transloadit_generic_elts={}),node.ownerTree._transloadit_generic_elts[data.transloaditname]=node},onChange:function(evt,elt){if(elt.ownerTree._transloadit_bound)return!1;elt.ownerTree._transloadit_bound=!0;var formElt=$(elt.ownerTree.domRoot);formElt.transloadit({autoSubmit:!1,wait:!0,onSuccess:function(assembly){var results=_.values(assembly.results);results=_.flatten(results),_.each(results,function(result){var id=elt.ownerTree._transloadit_generic_elts[result.field].id,input=formElt.find("#"+escapeSelector(id)),nonEmptyKeys=_.filter(_.keys(result.meta),function(key){return!!isSet(result.meta[key])});result.meta=_.pick(result.meta,nonEmptyKeys),input.val(JSON.stringify(result))}),elt.ownerTree._transloadit_bound=!1,formElt.unbind("submit.transloadit"),_.delay(function(){console.log("submit form"),elt.ownerTree.submit()},10)},onError:function(assembly){console.log("assembly error",assembly)}})},onInsert:function(evt,node){$(node.el).find("a._jsonform-delete").on("click",function(evt){return $(node.el).find("._jsonform-preview").remove(),$(node.el).find("a._jsonform-delete").remove(),$(node.el).find("#"+escapeSelector(node.id)).val(""),evt.preventDefault(),!1})},onSubmit:function(evt,elt){return!elt.ownerTree._transloadit_bound}},"file-transloadit":{template:"<span><% if (value && (value.type||value.url)) { %>"+fileDisplayTemplate+'<% } %><input class="input-file" id="_transloadit_<%= id %>" type="file" name="_transloadit_<%= node.name %>" /><input type="hidden" id="<%= id %>" name="<%= node.name %>" value=\'<%= escape(JSON.stringify(node.value)) %>\' /></span>',fieldtemplate:!0,inputfield:!0,getElement:function(el){return $(el).parent().get(0)},onChange:function(evt,elt){if(elt.ownerTree._transloadit_bound)return!1;elt.ownerTree._transloadit_bound=!0;var formElt=$(elt.ownerTree.domRoot);formElt.transloadit({autoSubmit:!1,wait:!0,onSuccess:function(assembly){var results=_.values(assembly.results);results=_.flatten(results),_.each(results,function(result){var input=formElt.find('input[name="'+result.field.replace(/^_transloadit_/,"")+'"]'),nonEmptyKeys=_.filter(_.keys(result.meta),function(key){return!!isSet(result.meta[key])});result.meta=_.pick(result.meta,nonEmptyKeys),input.val(JSON.stringify(result))}),elt.ownerTree._transloadit_bound=!1,formElt.unbind("submit.transloadit"),_.delay(function(){console.log("submit form"),elt.ownerTree.submit()},10)},onError:function(assembly){console.log("assembly error",assembly)}})},onInsert:function(evt,node){$(node.el).find("a._jsonform-delete").on("click",function(evt){return $(node.el).find("._jsonform-preview").remove(),$(node.el).find("a._jsonform-delete").remove(),$(node.el).find("#"+escapeSelector(node.id)).val(""),evt.preventDefault(),!1})},onSubmit:function(evt,elt){return!elt.ownerTree._transloadit_bound}},select:{template:'<select name="<%= node.name %>" id="<%= id %>"<%= (fieldHtmlClass ? " class=\'" + fieldHtmlClass + "\'" : "") %><%= (node.disabled? " disabled" : "")%><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %>> <% _.each(node.options, function(key, val) { if(key instanceof Object) { if (value === key.value) { %> <option selected value="<%= key.value %>"><%= key.title %></option> <% } else { %> <option value="<%= key.value %>"><%= key.title %></option> <% }} else { if (value === key) { %> <option selected value="<%= key %>"><%= key %></option> <% } else { %><option value="<%= key %>"><%= key %></option> <% }}}); %> </select>',fieldtemplate:!0,inputfield:!0},imageselect:{template:'<div><input type="hidden" name="<%= node.name %>" id="<%= node.id %>" value="<%= value %>" /><div class="dropdown"><a class="btn<% if (buttonClass && node.value) { %> <%= buttonClass %><% } %>" data-toggle="dropdown" href="#"<% if (node.value) { %> style="max-width:<%= width %>px;max-height:<%= height %>px"<% } %>><% if (node.value) { %><img src="<% if (!node.value.match(/^https?:/)) { %><%= prefix %><% } %><%= node.value %><%= suffix %>" alt="" /><% } else { %><%= buttonTitle %><% } %></a><div class="dropdown-menu navbar" id="<%= node.id %>_dropdown"><div><% _.each(node.options, function(key, idx) { if ((idx > 0) && ((idx % columns) === 0)) { %></div><div><% } %><a class="btn<% if (buttonClass) { %> <%= buttonClass %><% } %>" style="max-width:<%= width %>px;max-height:<%= height %>px"><% if (key instanceof Object) { %><img src="<% if (!key.value.match(/^https?:/)) { %><%= prefix %><% } %><%= key.value %><%= suffix %>" alt="<%= key.title %>" /></a><% } else { %><img src="<% if (!key.match(/^https?:/)) { %><%= prefix %><% } %><%= key %><%= suffix %>" alt="" /><% } %></a> <% }); %></div><div class="pagination-right"><a class="btn">Reset</a></div></div></div></div>',fieldtemplate:!0,inputfield:!0,onBeforeRender:function(data,node){var elt=node.formElement||{},nbRows=null,maxColumns=elt.imageSelectorColumns||5;data.buttonTitle=elt.imageSelectorTitle||"Select...",data.prefix=elt.imagePrefix||"",data.suffix=elt.imageSuffix||"",data.width=elt.imageWidth||32,data.height=elt.imageHeight||32,data.buttonClass=elt.imageButtonClass||!1,node.options.length>maxColumns?(nbRows=Math.ceil(node.options.length/maxColumns),data.columns=Math.ceil(node.options.length/nbRows)):data.columns=maxColumns},getElement:function(el){return $(el).parent().get(0)},onInsert:function(evt,node){$(node.el).on("click",".dropdown-menu a",function(evt){evt.preventDefault(),evt.stopPropagation();var img="img"===evt.target.nodeName.toLowerCase()?$(evt.target):$(evt.target).find("img"),value=img.attr("src"),elt=node.formElement||{},prefix=elt.imagePrefix||"",suffix=elt.imageSuffix||"",width=elt.imageWidth||32,height=elt.imageHeight||32;value?(0===value.indexOf(prefix)&&(value=value.substring(prefix.length)),value=value.substring(0,value.length-suffix.length),$(node.el).find("input").attr("value",value),$(node.el).find('a[data-toggle="dropdown"]').addClass(elt.imageButtonClass).attr("style","max-width:"+width+"px;max-height:"+height+"px").html('<img src="'+(value.match(/^https?:/)?"":prefix)+value+suffix+'" alt="" />')):($(node.el).find("input").attr("value",""),$(node.el).find('a[data-toggle="dropdown"]').removeClass(elt.imageButtonClass).removeAttr("style").html(elt.imageSelectorTitle||"Select..."))})}},radios:{template:'<div id="<%= node.id %>"><% _.each(node.options, function(key, val) { %><label class="radio"><input type="radio" <% if (((key instanceof Object) && (value === key.value)) || (value === key)) { %> checked="checked" <% } %> name="<%= node.name %>" value="<%= (key instanceof Object ? key.value : key) %>"<%= (node.disabled? " disabled" : "")%><%= (node.schemaElement && node.schemaElement.required ? " required=\'required\'" : "") %>/><span><%= (key instanceof Object ? key.title : key) %></span></label> <% }); %></div>',fieldtemplate:!0,inputfield:!0},radiobuttons:{template:'<div id="<%= node.id %>"><% _.each(node.options, function(key, val) { %><label class="radio btn"><input type="radio" style="position:absolute;left:-9999px;" <% if (((key instanceof Object) && (value === key.value)) || (value === key)) { %> checked="checked" <% } %> name="<%= node.name %>" value="<%= (key instanceof Object ? key.value : key) %>" /><span><%= (key instanceof Object ? key.title : key) %></span></label> <% }); %></div>',fieldtempate:!0,inputfield:!0,onInsert:function(evt,node){var activeClass="active",elt=node.formElement||{};elt.activeClass&&(activeClass+=" "+elt.activeClass),$(node.el).find("label").on("click",function(){$(this).parent().find("label").removeClass(activeClass),$(this).addClass(activeClass)})}},checkboxes:{template:"<div><%= choiceshtml %></div>",fieldtemplate:!0,inputfield:!0,onBeforeRender:function(data,node){var choices=null,choiceshtml=null,template='<label class="checkbox"><input type="checkbox" <% if (value) { %> checked="checked" <% } %> name="<%= name %>" value="1"<%= (node.disabled? " disabled" : "")%>/><span><%= title %></span></label>';node&&node.schemaElement&&node.schemaElement.items&&(choices=node.schemaElement.items["enum"]||node.schemaElement.items[0]["enum"],choices&&(choiceshtml="",_.each(choices,function(choice,idx){choiceshtml+=_.template(template,{name:node.key+"["+idx+"]",value:_.include(node.value,choice),title:node.formElement.titleMap?node.formElement.titleMap[choice]:choice,node:node},fieldTemplateSettings)}),data.choiceshtml=choiceshtml))}},array:{template:'<div id="<%= id %>"><ul class="_jsonform-array-ul" style="list-style-type:none;"><%= children %></ul><span class="_jsonform-array-buttons"><a href="#" class="btn _jsonform-array-addmore"><i class="icon-plus-sign" title="Add new"></i></a> <a href="#" class="btn _jsonform-array-deletelast"><i class="icon-minus-sign" title="Delete last"></i></a></span></div>',fieldtemplate:!0,array:!0,childTemplate:function(inner){return $("").sortable?'<li data-idx="<%= node.childPos %>"><span class="draggable line"><i class="icon-list" title="Move item"></i></span>'+inner+"</li>":'<li data-idx="<%= node.childPos %>">'+inner+"</li>"},onInsert:function(evt,node){var $nodeid=$(node.el).find("#"+escapeSelector(node.id)),boundaries=node.getArrayBoundaries(),moveNodeTo=function(fromIdx,toIdx){if(fromIdx!==toIdx){var incr=fromIdx<toIdx?1:-1,i=0,parentEl=$("> ul",$nodeid);for(i=fromIdx;i!==toIdx;i+=incr)node.children[i].switchValuesWith(node.children[i+incr]),node.children[i].render(parentEl.get(0)),node.children[i+incr].render(parentEl.get(0));var fromEl=$(node.children[fromIdx].el),toEl=$(node.children[toIdx].el);fromEl.detach(),toEl.detach(),fromIdx<toIdx?(0===fromIdx?parentEl.prepend(fromEl):$(node.children[fromIdx-1].el).after(fromEl),$(node.children[toIdx-1].el).after(toEl)):(0===toIdx?parentEl.prepend(toEl):$(node.children[toIdx-1].el).after(toEl),$(node.children[fromIdx-1].el).after(fromEl))}};$("> span > a._jsonform-array-addmore",$nodeid).click(function(evt){evt.preventDefault(),evt.stopPropagation();var idx=node.children.length;return!(boundaries.maxItems>=0&&(node.children.length>boundaries.maxItems-2&&$nodeid.find("> span > a._jsonform-array-addmore").addClass("disabled"),node.children.length>boundaries.maxItems-1))&&(node.insertArrayItem(idx,$("> ul",$nodeid).get(0)),void((boundaries.minItems<=0||boundaries.minItems>0&&node.children.length>boundaries.minItems-1)&&$nodeid.find("> span > a._jsonform-array-deletelast").removeClass("disabled")))});var curItems=$("> ul > li",$nodeid).length;if(boundaries.minItems>0&&curItems<boundaries.minItems)for(var i=0;i<boundaries.minItems-1&&$nodeid.find("> ul > li").length<boundaries.minItems;i++)node.insertArrayItem(curItems,$nodeid.find("> ul").get(0));boundaries.minItems>0&&node.children.length<=boundaries.minItems&&$nodeid.find("> span > a._jsonform-array-deletelast").addClass("disabled"),$("> span > a._jsonform-array-deletelast",$nodeid).click(function(evt){var idx=node.children.length-1;if(evt.preventDefault(),evt.stopPropagation(),boundaries.minItems>0){if(node.children.length<boundaries.minItems+2&&$nodeid.find("> span > a._jsonform-array-deletelast").addClass("disabled"),node.children.length<=boundaries.minItems)return!1}else 1===node.children.length&&$nodeid.find("> span > a._jsonform-array-deletelast").addClass("disabled");node.deleteArrayItem(idx),boundaries.maxItems>=0&&idx<=boundaries.maxItems-1&&$nodeid.find("> span > a._jsonform-array-addmore").removeClass("disabled")}),$(node.el).sortable&&($("> ul",$nodeid).sortable(),$("> ul",$nodeid).bind("sortstop",function(event,ui){var idx=$(ui.item).data("idx"),newIdx=$(ui.item).index();moveNodeTo(idx,newIdx)}))}},tabarray:{template:'<div id="<%= id %>"><div class="tabbable tabs-left"><ul class="nav nav-tabs"><%= tabs %></ul><div class="tab-content"><%= children %></div></div><a href="#" class="btn _jsonform-array-addmore"><i class="icon-plus-sign" title="Add new"></i></a> <a href="#" class="btn _jsonform-array-deleteitem"><i class="icon-minus-sign" title="Delete item"></i></a></div>',fieldtemplate:!0,array:!0,childTemplate:function(inner){return'<div data-idx="<%= node.childPos %>" class="tab-pane">'+inner+"</div>"},onBeforeRender:function(data,node){var tabs="";_.each(node.children,function(child,idx){var title=child.legend||child.title||"Item "+(idx+1);tabs+='<li data-idx="'+idx+'"'+(0===idx?' class="active"':"")+'><a class="draggable tab" data-toggle="tab">'+escapeHTML(title)+"</a></li>"}),data.tabs=tabs},onInsert:function(evt,node){var $nodeid=$(node.el).find("#"+escapeSelector(node.id)),boundaries=node.getArrayBoundaries(),moveNodeTo=function(fromIdx,toIdx){if(fromIdx!==toIdx){var incr=fromIdx<toIdx?1:-1,i=0,tabEl=$("> .tabbable > .tab-content",$nodeid).get(0);for(i=fromIdx;i!==toIdx;i+=incr)node.children[i].switchValuesWith(node.children[i+incr]),node.children[i].render(tabEl),node.children[i+incr].render(tabEl)}},updateTabs=function(selIdx){var tabs="",activateFirstTab=!1;void 0===selIdx&&(selIdx=$("> .tabbable > .nav-tabs .active",$nodeid).data("idx"),selIdx?selIdx=parseInt(selIdx,10):(activateFirstTab=!0,selIdx=0)),selIdx>=node.children.length&&(selIdx=node.children.length-1),_.each(node.children,function(child,idx){var title=child.legend||child.title||"Item "+(idx+1);tabs+='<li data-idx="'+idx+'"><a class="draggable tab" data-toggle="tab">'+escapeHTML(title)+"</a></li>"}),$("> .tabbable > .nav-tabs",$nodeid).html(tabs),activateFirstTab&&$('> .tabbable > .nav-tabs [data-idx="0"]',$nodeid).addClass("active"),$('> .tabbable > .nav-tabs [data-toggle="tab"]',$nodeid).eq(selIdx).click()};if($("> a._jsonform-array-deleteitem",$nodeid).click(function(evt){var idx=$("> .tabbable > .nav-tabs .active",$nodeid).data("idx");return evt.preventDefault(),evt.stopPropagation(),!(boundaries.minItems>0&&(node.children.length<boundaries.minItems+1&&$nodeid.find("> a._jsonform-array-deleteitem").addClass("disabled"),node.children.length<=boundaries.minItems))&&(node.deleteArrayItem(idx),updateTabs(),(node.children.length<boundaries.minItems+1||0===node.children.length)&&$nodeid.find("> a._jsonform-array-deleteitem").addClass("disabled"),void(boundaries.maxItems>=0&&node.children.length<=boundaries.maxItems&&$nodeid.find("> a._jsonform-array-addmore").removeClass("disabled")))}),$("> a._jsonform-array-addmore",$nodeid).click(function(evt){var idx=node.children.length;return!(boundaries.maxItems>=0&&(node.children.length>boundaries.maxItems-2&&$("> a._jsonform-array-addmore",$nodeid).addClass("disabled"),node.children.length>boundaries.maxItems-1))&&(evt.preventDefault(),evt.stopPropagation(),node.insertArrayItem(idx,$nodeid.find("> .tabbable > .tab-content").get(0)),updateTabs(idx),void((boundaries.minItems<=0||boundaries.minItems>0&&idx>boundaries.minItems-1)&&$nodeid.find("> a._jsonform-array-deleteitem").removeClass("disabled")))}),$(node.el).on("legendUpdated",function(evt){updateTabs(),evt.preventDefault(),evt.stopPropagation()}),$(node.el).sortable&&($("> .tabbable > .nav-tabs",$nodeid).sortable({containment:node.el,tolerance:"pointer"}),$("> .tabbable > .nav-tabs",$nodeid).bind("sortstop",function(event,ui){var idx=$(ui.item).data("idx"),newIdx=$(ui.item).index();moveNodeTo(idx,newIdx),updateTabs(newIdx)})),boundaries.minItems>=0){for(var i=0;i<boundaries.minItems-1;i++)$nodeid.find("> a._jsonform-array-addmore").click();$nodeid.find("> a._jsonform-array-deleteitem").addClass("disabled"),updateTabs()}boundaries.maxItems>=0&&node.children.length>=boundaries.maxItems&&$nodeid.find("> a._jsonform-array-addmore").addClass("disabled"),boundaries.minItems>=0&&node.children.length<=boundaries.minItems&&$nodeid.find("> a._jsonform-array-deleteitem").addClass("disabled")}},help:{template:'<span class="help-block" style="padding-top:5px"><%= elt.helpvalue %></span>',fieldtemplate:!0},msg:{template:"<%= elt.msg %>"},fieldset:{template:'<fieldset class="control-group jsonform-error-<%= keydash %> <% if (elt.expandable) { %>expandable<% } %> <%= elt.htmlClass?elt.htmlClass:"" %>" <% if (id) { %> id="<%= id %>"<% } %>><% if (node.title || node.legend) { %><legend><%= node.title || node.legend %></legend><% } %><% if (elt.expandable) { %><div class="control-group"><% } %><%= children %><% if (elt.expandable) { %></div><% } %></fieldset>'},advancedfieldset:{template:'<fieldset<% if (id) { %> id="<%= id %>"<% } %> class="expandable <%= elt.htmlClass?elt.htmlClass:"" %>"><legend>Advanced options</legend><div class="control-group"><%= children %></div></fieldset>'},authfieldset:{template:'<fieldset<% if (id) { %> id="<%= id %>"<% } %> class="expandable <%= elt.htmlClass?elt.htmlClass:"" %>"><legend>Authentication settings</legend><div class="control-group"><%= children %></div></fieldset>'},submit:{template:'<input type="submit" <% if (id) { %> id="<%= id %>" <% } %> class="btn btn-primary <%= elt.htmlClass?elt.htmlClass:"" %>" value="<%= value || node.title %>"<%= (node.disabled? " disabled" : "")%>/>'},button:{template:' <button <% if (id) { %> id="<%= id %>" <% } %> class="btn <%= elt.htmlClass?elt.htmlClass:"" %>"><%= node.title %></button> '},actions:{template:'<div class="form-actions <%= elt.htmlClass?elt.htmlClass:"" %>"><%= children %></div>'},hidden:{template:'<input type="hidden" id="<%= id %>" name="<%= node.name %>" value="<%= escape(value) %>" />',inputfield:!0},selectfieldset:{template:'<fieldset class="tab-container <%= elt.htmlClass?elt.htmlClass:"" %>"><% if (node.legend) { %><legend><%= node.legend %></legend><% } %><% if (node.formElement.key) { %><input type="hidden" id="<%= node.id %>" name="<%= node.name %>" value="<%= escape(value) %>" /><% } else { %><a id="<%= node.id %>"></a><% } %><div class="tabbable"><div class="control-group<%= node.formElement.hideMenu ? " hide" : "" %>"><% if (node.title && !elt.notitle) { %><label class="control-label" for="<%= node.id %>"><%= node.title %></label><% } %><div class="controls"><%= tabs %></div></div><div class="tab-content"><%= children %></div></div></fieldset>',inputfield:!0,getElement:function(el){return $(el).parent().get(0)},childTemplate:function(inner){return'<div data-idx="<%= node.childPos %>" class="tab-pane<% if (node.active) { %> active<% } %>">'+inner+"</div>"},onBeforeRender:function(data,node){var children=null,choices=[];node.schemaElement&&(choices=node.schemaElement["enum"]||[]),children=node.options?_.map(node.options,function(option,idx){var child=node.children[idx];return option instanceof Object?(option=_.extend({node:child},option),option.title=option.title||child.legend||child.title||"Option "+(child.childPos+1),option.value=isSet(option.value)?option.value:isSet(choices[idx])?choices[idx]:idx,option):{title:option,value:isSet(choices[child.childPos])?choices[child.childPos]:child.childPos,node:child}}):_.map(node.children,function(child,idx){return{title:child.legend||child.title||"Option "+(child.childPos+1),value:choices[child.childPos]||child.childPos,node:child}});var activeChild=null;data.value&&(activeChild=_.find(children,function(child){return child.value===node.value})),activeChild||(activeChild=_.find(children,function(child){return child.node.hasNonDefaultValue()})),activeChild||(activeChild=children[0]),activeChild.node.active=!0,data.value=activeChild.value;var tabs=(node.formElement,'<select class="nav"'+(node.disabled?" disabled":"")+">");return _.each(children,function(child,idx){tabs+='<option data-idx="'+idx+'" value="'+child.value+'"'+(child.node.active?' class="active"':"")+">"+escapeHTML(child.title)+"</option>"}),tabs+="</select>",data.tabs=tabs,data},onInsert:function(evt,node){$(node.el).find("select.nav").first().on("change",function(evt){var $option=$(this).find("option:selected");$(node.el).find('input[type="hidden"]').first().val($option.attr("value"))})}},optionfieldset:{template:'<div<% if (node.id) { %> id="<%= node.id %>"<% } %>><%= children %></div>'},section:{template:'<div<% if (node.id) { %> id="<%= node.id %>"<% } %>><%= children %></div>'},questions:{template:'<div><input type="hidden" id="<%= node.id %>" name="<%= node.name %>" value="<%= escape(value) %>" /><%= children %></div>',fieldtempate:!0,inputfield:!0,getElement:function(el){return $(el).parent().get(0)},onInsert:function(evt,node){node.children&&0!==node.children.length&&(_.each(node.children,function(child){$(child.el).hide()}),$(node.children[0].el).show())}},question:{template:'<div id="<%= node.id %>"><% _.each(node.options, function(key, val) { %><label class="radio<%= (node.formElement.optionsType === "radiobuttons") ? " btn" : "" %><%= ((key instanceof Object && key.htmlClass) ? " " + key.htmlClass : "") %>"><input type="radio" <% if (node.formElement.optionsType === "radiobuttons") { %> style="position:absolute;left:-9999px;" <% } %>name="<%= node.id %>" value="<%= val %>"<%= (node.disabled? " disabled" : "")%>/><span><%= (key instanceof Object ? key.title : key) %></span></label> <% }); %></div>',fieldtemplate:!0,onInsert:function(evt,node){var activeClass="active",elt=node.formElement||{};elt.activeClass&&(activeClass+=" "+elt.activeClass),
$(node.el).find('input[type="radio"]').on("change",function(evt){var questionNode=null,option=node.options[$(this).val()];node.parentNode&&node.parentNode.el&&($(this).parent().parent().find("label").removeClass(activeClass),$(this).parent().addClass(activeClass),$(node.el).nextAll().hide(),$(node.el).nextAll().find('input[type="radio"]').prop("checked",!1),option.value&&$(node.parentNode.el).find('input[type="hidden"]').val(option.value),option.next&&(questionNode=_.find(node.parentNode.children,function(child){return child.formElement&&child.formElement.qid===option.next}),$(questionNode.el).show(),$(questionNode.el).nextAll().hide(),$(questionNode.el).nextAll().find('input[type="radio"]').prop("checked",!1)),option.href&&(option.target?window.open(option.href,option.target):window.location=option.href),option.submit&&setTimeout(function(){node.ownerTree.submit()},0))})}}},jsonform.util.getObjKey=function(obj,key,ignoreArrays){for(var innerobj=obj,keyparts=key.split("."),subkey=null,arrayMatch=null,prop=null,i=0;i<keyparts.length;i++){if(null===innerobj||"object"!=typeof innerobj)return null;if(subkey=keyparts[i],prop=subkey.replace(reArray,""),reArray.lastIndex=0,arrayMatch=reArray.exec(subkey))for(;;){if(!_.isArray(innerobj[prop]))return null;if(innerobj=innerobj[prop][parseInt(arrayMatch[1],10)],arrayMatch=reArray.exec(subkey),!arrayMatch)break}else innerobj=ignoreArrays&&!innerobj[prop]&&_.isArray(innerobj)&&innerobj[0]?innerobj[0][prop]:innerobj[prop]}return ignoreArrays&&_.isArray(innerobj)&&innerobj[0]?innerobj[0]:innerobj},jsonform.util.setObjKey=function(obj,key,value){for(var innerobj=obj,keyparts=key.split("."),subkey=null,arrayMatch=null,prop=null,i=0;i<keyparts.length-1;i++)if(subkey=keyparts[i],prop=subkey.replace(reArray,""),reArray.lastIndex=0,arrayMatch=reArray.exec(subkey)){for(;;)if(_.isArray(innerobj[prop])||(innerobj[prop]=[]),innerobj=innerobj[prop],prop=parseInt(arrayMatch[1],10),arrayMatch=reArray.exec(subkey),!arrayMatch)break;"object"==typeof innerobj[prop]&&null!==innerobj[prop]||(innerobj[prop]={}),innerobj=innerobj[prop]}else"object"==typeof innerobj[prop]&&null!==innerobj[prop]||(innerobj[prop]={}),innerobj=innerobj[prop];if(subkey=keyparts[keyparts.length-1],prop=subkey.replace(reArray,""),reArray.lastIndex=0,arrayMatch=reArray.exec(subkey)){for(;;)if(_.isArray(innerobj[prop])||(innerobj[prop]=[]),innerobj=innerobj[prop],prop=parseInt(arrayMatch[1],10),arrayMatch=reArray.exec(subkey),!arrayMatch)break;innerobj[prop]=value}else innerobj[prop]=value};var getSchemaKey=function(schema,key){var schemaKey=key.replace(/\./g,".properties.").replace(/\[[0-9]*\]/g,".items"),schemaDef=jsonform.util.getObjKey(schema,schemaKey,!0);if(schemaDef&&schemaDef.$ref)throw new Error("JSONForm does not yet support schemas that use the $ref keyword. See: https://github.com/joshfire/jsonform/issues/54");return schemaDef},truncateToArrayDepth=function(key,arrayDepth){var depth=0,pos=0;if(!key)return null;if(arrayDepth>0)for(;depth<arrayDepth;){if(pos=key.indexOf("[]",pos),pos===-1)return key;pos+=2,depth+=1}return pos=key.indexOf("[]",pos),pos===-1?key:key.substring(0,pos)},applyArrayPath=function(key,arrayPath){var depth=0;if(!key)return null;if(!arrayPath||0===arrayPath.length)return key;var newKey=key.replace(reArray,function(str,p1){var newIndex=str;return isSet(arrayPath[depth])&&(newIndex="["+arrayPath[depth]+"]"),depth+=1,newIndex});return newKey},getInitialValue=function(formObject,key,arrayPath,tpldata,usePreviousValues){var value=null;tpldata=tpldata||{},tpldata.idx=tpldata.idx||(arrayPath?arrayPath[arrayPath.length-1]:1),tpldata.value=isSet(tpldata.value)?tpldata.value:"",tpldata.getValue=tpldata.getValue||function(key){return getInitialValue(formObject,key,arrayPath,tpldata,usePreviousValues)};var getFormElement=function(elements,key){var formElement=null;return elements&&elements.length?(_.each(elements,function(elt){if(!formElement)return elt===key?void(formElement={key:elt}):void(_.isString(elt)||(elt.key===key?formElement=elt:elt.items&&(formElement=getFormElement(elt.items,key))))}),formElement):null},formElement=getFormElement(formObject.form||[],key),schemaElement=getSchemaKey(formObject.schema.properties,key);return usePreviousValues&&formObject.value&&(value=jsonform.util.getObjKey(formObject.value,applyArrayPath(key,arrayPath))),isSet(value)||(formElement&&"undefined"!=typeof formElement.value?value=formElement.value:schemaElement&&isSet(schemaElement["default"])&&(value=schemaElement["default"]),value&&value.indexOf("{{values.")!==-1&&(value=value.replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}')),value&&(value=_.template(value,tpldata,valueTemplateSettings))),isSet(value)&&formElement&&formElement.titleMap&&formElement.titleMap[value]&&(value=_.template(formElement.titleMap[value],tpldata,valueTemplateSettings)),value&&_.isString(value)&&schemaElement&&schemaElement.maxLength&&value.length>schemaElement.maxLength&&(value=value.substr(0,schemaElement.maxLength-1)+"â€¦"),isSet(value)?value:null},formNode=function(){this.id=null,this.key=null,this.el=null,this.formElement=null,this.schemaElement=null,this.view=null,this.children=[],this.ownerTree=null,this.parentNode=null,this.childTemplate=null,this.legendChild=null,this.arrayPath=[],this.childPos=0};formNode.prototype.clone=function(parentNode){var node=new formNode;return node.arrayPath=_.clone(this.arrayPath),node.ownerTree=this.ownerTree,node.parentNode=parentNode||this.parentNode,node.formElement=this.formElement,node.schemaElement=this.schemaElement,node.view=this.view,node.children=_.map(this.children,function(child){return child.clone(node)}),this.childTemplate&&(node.childTemplate=this.childTemplate.clone(node)),node},formNode.prototype.hasNonDefaultValue=function(){if(this.formElement&&"hidden"==this.formElement.type)return!1;if(this.value&&!this.defaultValue)return!0;var child=_.find(this.children,function(child){return child.hasNonDefaultValue()});return!!child},formNode.prototype.appendChild=function(node){return node.parentNode=this,node.childPos=this.children.length,this.children.push(node),node},formNode.prototype.removeChild=function(){var child=this.children[this.children.length-1];if(child)return $(child.el).remove(),this.children.pop()},formNode.prototype.moveValuesTo=function(node){var values=this.getFormValues(node.arrayPath);node.resetValues(),node.computeInitialValues(values,!0)},formNode.prototype.switchValuesWith=function(node){var values=this.getFormValues(node.arrayPath),nodeValues=node.getFormValues(this.arrayPath);node.resetValues(),node.computeInitialValues(values,!0),this.resetValues(),this.computeInitialValues(nodeValues,!0)},formNode.prototype.resetValues=function(){var params=null;if(this.value=null,this.parentNode?(this.arrayPath=_.clone(this.parentNode.arrayPath),this.parentNode.view&&this.parentNode.view.array&&this.arrayPath.push(this.childPos)):this.arrayPath=[],this.view&&this.view.inputfield)params=$(":input",this.el).serializeArray(),_.each(params,function(param){$('[name="'+escapeSelector(param.name)+'"]',$(this.el)).val("")},this);else if(this.view&&this.view.array)for(;this.children.length>0;)this.removeChild();_.each(this.children,function(child){child.resetValues()})},formNode.prototype.setChildTemplate=function(node){this.childTemplate=node,node.parentNode=this},formNode.prototype.computeInitialValues=function(values,ignoreDefaultValues){var self=this,node=null,nbChildren=1,i=0,formData=this.ownerTree.formDesc.tpldata||{};if(this.parentNode?(this.arrayPath=_.clone(this.parentNode.arrayPath),this.parentNode.view&&this.parentNode.view.array&&this.arrayPath.push(this.childPos)):this.arrayPath=[],formData.idx=this.arrayPath.length>0?this.arrayPath[this.arrayPath.length-1]+1:this.childPos+1,formData.value="",formData.getValue=function(key){return getInitialValue(self.ownerTree.formDesc,key,self.arrayPath,formData,!!values)},this.formElement&&(this.formElement.id?this.id=applyArrayPath(this.formElement.id,this.arrayPath):this.view&&this.view.array?this.id=escapeSelector(this.ownerTree.formDesc.prefix)+"-elt-counter-"+_.uniqueId():this.parentNode&&this.parentNode.view&&this.parentNode.view.array?this.id=escapeSelector(this.ownerTree.formDesc.prefix)+"-elt-counter-"+_.uniqueId():"button"!==this.formElement.type&&"selectfieldset"!==this.formElement.type&&"question"!==this.formElement.type&&"buttonquestion"!==this.formElement.type||(this.id=escapeSelector(this.ownerTree.formDesc.prefix)+"-elt-counter-"+_.uniqueId()),this.formElement.key&&(this.key=applyArrayPath(this.formElement.key,this.arrayPath),this.keydash=this.key.replace(/\./g,"---")),this.name=applyArrayPath(this.formElement.name,this.arrayPath),_.each(["title","legend","description","append","prepend","inlinetitle","helpvalue","value","disabled","placeholder","readOnly"],function(prop){_.isString(this.formElement[prop])?(this.formElement[prop].indexOf("{{values.")!==-1?this[prop]=this.formElement[prop].replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}'):this[prop]=applyArrayPath(this.formElement[prop],this.arrayPath),this[prop]&&(this[prop]=_.template(this[prop],formData,valueTemplateSettings))):this[prop]=this.formElement[prop]},this),this.formElement.options&&(this.options=_.map(this.formElement.options,function(option){var title=null;return _.isObject(option)&&option.title?(title=option.title.indexOf("{{values.")!==-1?option.title.replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}'):applyArrayPath(option.title,self.arrayPath),_.extend({},option,{value:isSet(option.value)?option.value:"",title:_.template(title,formData,valueTemplateSettings)})):option}))),this.view&&this.view.inputfield&&this.schemaElement)values?isSet(jsonform.util.getObjKey(values,this.key))&&(this.value=jsonform.util.getObjKey(values,this.key)):ignoreDefaultValues||!isSet(this.value)&&isSet(this.schemaElement["default"])&&(this.value=this.schemaElement["default"],_.isString(this.value)&&(this.value.indexOf("{{values.")!==-1?this.value=this.value.replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}'):this.value=applyArrayPath(this.value,this.arrayPath),this.value&&(this.value=_.template(this.value,formData,valueTemplateSettings))),this.defaultValue=!0);else if(this.view&&this.view.array)for(nbChildren=0,values?nbChildren=this.getPreviousNumberOfItems(values,this.arrayPath):0===nbChildren&&(nbChildren=1),i=0;i<nbChildren;i++)this.appendChild(this.childTemplate.clone());if(_.each(this.children,function(child){child.computeInitialValues(values,ignoreDefaultValues)}),this.formElement&&this.formElement.valueInLegend)for(node=this;node;){if(node.parentNode&&node.parentNode.view&&node.parentNode.view.array&&(node.legendChild=this,node.formElement&&node.formElement.legend)){node.legend=applyArrayPath(node.formElement.legend,node.arrayPath),formData.idx=node.arrayPath.length>0?node.arrayPath[node.arrayPath.length-1]+1:node.childPos+1,formData.value=isSet(this.value)?this.value:"",node.legend=_.template(node.legend,formData,valueTemplateSettings);break}node=node.parentNode}},formNode.prototype.getPreviousNumberOfItems=function(values,arrayPath){var key=null,arrayValue=null,childNumbers=null;return values?this.view.inputfield&&this.schemaElement?(key=truncateToArrayDepth(this.formElement.key,arrayPath.length),key=applyArrayPath(key,arrayPath),(arrayValue=jsonform.util.getObjKey(values,key))?(childNumbers=_.map(this.children,function(child){return child.getPreviousNumberOfItems(values,arrayPath)}),_.max([_.max(childNumbers)||0,arrayValue.length])):0):this.view.array?this.childTemplate.getPreviousNumberOfItems(values,arrayPath):(childNumbers=_.map(this.children,function(child){return child.getPreviousNumberOfItems(values,arrayPath)}),_.max(childNumbers)||0):0},formNode.prototype.getFormValues=function(updateArrayPath){var values={};if(!this.el)throw new Error("formNode.getFormValues can only be called on nodes that are associated with a DOM element in the tree");var formArray=$(":input",this.el).serializeArray();formArray=formArray.concat($(":input[type=checkbox]:not(:disabled):not(:checked)",this.el).map(function(){return{name:this.name,value:this.checked}}).get()),updateArrayPath&&_.each(formArray,function(param){param.name=applyArrayPath(param.name,updateArrayPath)});for(var formSchema=this.ownerTree.formDesc.schema,i=0;i<formArray.length;i++){var name=formArray[i].name,eltSchema=getSchemaKey(formSchema.properties,name),arrayMatch=null,cval=null;if(eltSchema)if(eltSchema._jsonform_checkboxes_as_array&&(arrayMatch=name.match(/\[([0-9]*)\]$/)))name=name.replace(/\[([0-9]*)\]$/,""),cval=jsonform.util.getObjKey(values,name)||[],"1"===formArray[i].value&&cval.push(eltSchema["enum"][parseInt(arrayMatch[1],10)]),jsonform.util.setObjKey(values,name,cval);else{if("boolean"===eltSchema.type&&("0"===formArray[i].value?formArray[i].value=!1:formArray[i].value=!!formArray[i].value),"number"!==eltSchema.type&&"integer"!==eltSchema.type||_.isString(formArray[i].value)&&(formArray[i].value.length?isNaN(Number(formArray[i].value))||(formArray[i].value=Number(formArray[i].value)):formArray[i].value=null),"string"!==eltSchema.type||""!==formArray[i].value||eltSchema._jsonform_allowEmpty||(formArray[i].value=null),"object"===eltSchema.type&&_.isString(formArray[i].value)&&"{"===formArray[i].value.substring(0,1))try{formArray[i].value=JSON.parse(formArray[i].value)}catch(e){formArray[i].value={}}"object"!==eltSchema.type||"null"!==formArray[i].value&&""!==formArray[i].value||(formArray[i].value=null),formArray[i].name&&null!==formArray[i].value&&jsonform.util.setObjKey(values,formArray[i].name,formArray[i].value)}}return values},formNode.prototype.render=function(el){var html=this.generate();this.setContent(html,el),this.enhance()},formNode.prototype.setContent=function(html,parentEl){var node=$(html),parentNode=parentEl||(this.parentNode?this.parentNode.el:this.ownerTree.domRoot),nextSibling=null;this.el?$(this.el).replaceWith(node):(nextSibling=$(parentNode).children().get(this.childPos),nextSibling?$(nextSibling).before(node):$(parentNode).append(node)),this.el=node,this.updateElement(this.el)},formNode.prototype.updateElement=function(domNode){this.id&&(this.el=$("#"+escapeSelector(this.id),domNode).get(0),this.view&&this.view.getElement&&(this.el=this.view.getElement(this.el)),this.fieldtemplate!==!1&&this.view&&this.view.fieldtemplate&&(this.el=$(this.el).parent().parent(),(this.prepend||this.prepend)&&(this.el=this.el.parent()),this.el=this.el.get(0)),this.parentNode&&this.parentNode.view&&this.parentNode.view.childTemplate&&(this.el=$(this.el).parent().get(0))),_.each(this.children,function(child){child.updateElement(this.el||domNode)})},formNode.prototype.generate=function(){var data={id:this.id,keydash:this.keydash,elt:this.formElement,schema:this.schemaElement,node:this,value:isSet(this.value)?this.value:"",escape:escapeHTML},template=null,html="";this.ownerTree.formDesc.onBeforeRender&&this.ownerTree.formDesc.onBeforeRender(data,this),this.view.onBeforeRender&&this.view.onBeforeRender(data,this),template=this.template?this.template:this.formElement&&this.formElement.template?this.formElement.template:this.view.template,this.fieldtemplate!==!1&&(this.fieldtemplate||this.view.fieldtemplate)&&(template=jsonform.fieldTemplate(template)),this.parentNode&&this.parentNode.view&&this.parentNode.view.childTemplate&&(template=this.parentNode.view.childTemplate(template));var childrenhtml="";return _.each(this.children,function(child){childrenhtml+=child.generate()}),data.children=childrenhtml,data.fieldHtmlClass="",this.ownerTree&&this.ownerTree.formDesc&&this.ownerTree.formDesc.params&&this.ownerTree.formDesc.params.fieldHtmlClass&&(data.fieldHtmlClass=this.ownerTree.formDesc.params.fieldHtmlClass),this.formElement&&"undefined"!=typeof this.formElement.fieldHtmlClass&&(data.fieldHtmlClass=this.formElement.fieldHtmlClass),html=_.template(template,data,fieldTemplateSettings)},formNode.prototype.enhance=function(){var node=this,handlers=null,handler=null,formData=_.clone(this.ownerTree.formDesc.tpldata)||{};this.formElement&&(this.view.onInsert&&this.view.onInsert({target:$(this.el)},this),handlers=this.handlers||this.formElement.handlers,handler=this.onInsert||this.formElement.onInsert,handler&&handler({target:$(this.el)},this),handlers&&_.each(handlers,function(handler,onevent){"insert"===onevent&&handler({target:$(this.el)},this)},this),this.el&&(this.onChange&&$(this.el).bind("change",function(evt){node.onChange(evt,node)}),this.view.onChange&&$(this.el).bind("change",function(evt){node.view.onChange(evt,node)}),this.formElement.onChange&&$(this.el).bind("change",function(evt){node.formElement.onChange(evt,node)}),this.onClick&&$(this.el).bind("click",function(evt){node.onClick(evt,node)}),this.view.onClick&&$(this.el).bind("click",function(evt){node.view.onClick(evt,node)}),this.formElement.onClick&&$(this.el).bind("click",function(evt){node.formElement.onClick(evt,node)}),this.onKeyUp&&$(this.el).bind("keyup",function(evt){node.onKeyUp(evt,node)}),this.view.onKeyUp&&$(this.el).bind("keyup",function(evt){node.view.onKeyUp(evt,node)}),this.formElement.onKeyUp&&$(this.el).bind("keyup",function(evt){node.formElement.onKeyUp(evt,node)}),handlers&&_.each(handlers,function(handler,onevent){"insert"!==onevent&&$(this.el).bind(onevent,function(evt){handler(evt,node)})},this)),this.legendChild&&this.legendChild.formElement&&$(this.legendChild.el).bind("keyup",function(evt){node.formElement&&node.formElement.legend&&node.parentNode&&(node.legend=applyArrayPath(node.formElement.legend,node.arrayPath),formData.idx=node.arrayPath.length>0?node.arrayPath[node.arrayPath.length-1]+1:node.childPos+1,formData.value=$(evt.target).val(),node.legend=_.template(node.legend,formData,valueTemplateSettings),$(node.parentNode.el).trigger("legendUpdated"))})),_.each(this.children,function(child){child.enhance()})},formNode.prototype.insertArrayItem=function(idx,domElement){var i=0;void 0===idx&&(idx=this.children.length);var child=this.childTemplate.clone();for(this.appendChild(child),child.resetValues(),i=this.children.length-2;i>=idx;i--)this.children[i].moveValuesTo(this.children[i+1]);for(this.children[idx].resetValues(),this.children[idx].computeInitialValues(),i=idx;i<this.children.length;i++)this.children[i].render(domElement)},formNode.prototype.deleteArrayItem=function(idx){var i=0;for(void 0===idx&&(idx=this.children.length-1),i=idx;i<this.children.length-1;i++)this.children[i+1].moveValuesTo(this.children[i]),this.children[i].render();this.removeChild()},formNode.prototype.getArrayBoundaries=function(){var boundaries={minItems:-1,maxItems:-1};if(!this.view||!this.view.array)return boundaries;var getNodeBoundaries=function(node,initialNode){var schemaKey=null,arrayKey=null,boundaries={minItems:-1,maxItems:-1};return initialNode=initialNode||node,node.view&&node.view.array&&node!==initialNode?boundaries:node.key?(arrayKey=node.key.replace(/\[[0-9]+\]/g,"[]"),node!==initialNode&&(arrayKey=arrayKey.replace(/\[\][^\[\]]*$/,"")),schemaKey=getSchemaKey(node.ownerTree.formDesc.schema.properties,arrayKey),schemaKey?{minItems:schemaKey.minItems||schemaKey.minLength||-1,maxItems:schemaKey.maxItems||schemaKey.maxLength||-1}:boundaries):(_.each(node.children,function(child){var subBoundaries=getNodeBoundaries(child,initialNode);subBoundaries.minItems!==-1&&(boundaries.minItems!==-1?boundaries.minItems=Math.max(boundaries.minItems,subBoundaries.minItems):boundaries.minItems=subBoundaries.minItems),subBoundaries.maxItems!==-1&&(boundaries.maxItems!==-1?boundaries.maxItems=Math.min(boundaries.maxItems,subBoundaries.maxItems):boundaries.maxItems=subBoundaries.maxItems)}),boundaries)};return getNodeBoundaries(this)};var formTree=function(){this.eventhandlers=[],this.root=null,this.formDesc=null};formTree.prototype.initialize=function(formDesc){formDesc=formDesc||{},this.formDesc=_.clone(formDesc),this.formDesc.prefix=this.formDesc.prefix||"jsonform-"+_.uniqueId(),this.formDesc.schema&&!this.formDesc.schema.properties&&(this.formDesc.schema={properties:this.formDesc.schema}),this.formDesc.form=this.formDesc.form||["*",{type:"actions",items:[{type:"submit",value:"Submit"}]}],this.formDesc.form=_.isArray(this.formDesc.form)?this.formDesc.form:[this.formDesc.form],this.formDesc.params=this.formDesc.params||{},this.root=new formNode,this.root.ownerTree=this,this.root.view=jsonform.elementTypes.root,this.buildTree(),this.computeInitialValues()},formTree.prototype.buildTree=function(){_.each(this.formDesc.form,function(formElement){"*"===formElement?_.each(this.formDesc.schema.properties,function(element,key){this.root.appendChild(this.buildFromLayout({key:key}))},this):(_.isString(formElement)&&(formElement={key:formElement}),this.root.appendChild(this.buildFromLayout(formElement)))},this)},formTree.prototype.buildFromLayout=function(formElement,context){var schemaElement=null,node=new formNode,view=null,key=null;if(formElement=_.clone(formElement),formElement.items&&(_.isArray(formElement.items)?formElement.items=_.map(formElement.items,_.clone):formElement.items=[_.clone(formElement.items)]),formElement.key){if(schemaElement=getSchemaKey(this.formDesc.schema.properties,formElement.key),!schemaElement)throw new Error('The JSONForm object references the schema key "'+formElement.key+'" but that key does not exist in the JSON schema');if(this.formDesc.onElementSchema&&this.formDesc.onElementSchema(formElement,schemaElement),formElement.name=formElement.name||formElement.key,formElement.title=formElement.title||schemaElement.title,formElement.description=formElement.description||schemaElement.description,formElement.readOnly=formElement.readOnly||schemaElement.readOnly||formElement.readonly||schemaElement.readonly,formElement.id||(formElement.id=escapeSelector(this.formDesc.prefix)+"-elt-"+formElement.key),formElement.allowEmpty&&(schemaElement._jsonform_allowEmpty=!0),formElement.type||("string"===schemaElement.type&&"color"===schemaElement.format?formElement.type="color":"number"!==schemaElement.type&&"integer"!==schemaElement.type&&"string"!==schemaElement.type&&"any"!==schemaElement.type||schemaElement["enum"]?"boolean"===schemaElement.type?formElement.type="checkbox":"object"===schemaElement.type?schemaElement.properties?formElement.type="fieldset":formElement.type="textarea":_.isUndefined(schemaElement["enum"])?formElement.type=schemaElement.type:formElement.type="select":formElement.type="text"),!formElement.options&&schemaElement["enum"]&&(formElement.titleMap?formElement.options=_.map(schemaElement["enum"],function(value){return{value:value,title:formElement.titleMap[value]||value}}):formElement.options=schemaElement["enum"]),"checkboxes"===formElement.type&&schemaElement.items){var itemsEnum=schemaElement.items["enum"];itemsEnum&&(schemaElement.items._jsonform_checkboxes_as_array=!0),!itemsEnum&&schemaElement.items[0]&&(itemsEnum=schemaElement.items[0]["enum"],itemsEnum&&(schemaElement.items[0]._jsonform_checkboxes_as_array=!0))}"object"===schemaElement.type&&_.each(schemaElement.properties,function(prop,propName){node.appendChild(this.buildFromLayout({key:formElement.key+"."+propName}))},this)}if(formElement.type||(formElement.type="none"),view=jsonform.elementTypes[formElement.type],!view)throw new Error('The JSONForm contains an element whose type is unknown: "'+formElement.type+'"');if(schemaElement){if(!view.inputfield&&!view.array&&"selectfieldset"!==formElement.type&&"object"!==schemaElement.type)throw new Error('The JSONForm contains an element that links to an element in the JSON schema (key: "'+formElement.key+'") and that should not based on its type ("'+formElement.type+'")')}else if(view.inputfield&&"selectfieldset"!==formElement.type)throw new Error('The JSONForm defines an element of type "'+formElement.type+'" but no "key" property to link the input field to the JSON schema');return formElement.iddot=escapeSelector(formElement.id||""),node.formElement=formElement,node.schemaElement=schemaElement,node.view=view,node.ownerTree=this,formElement.handlers||(formElement.handlers={}),node.view.array?(key=formElement.items?formElement.items[0]||formElement.items:formElement.key+"[]",_.isString(key)&&(key={key:key}),node.setChildTemplate(this.buildFromLayout(key))):formElement.items&&_.each(formElement.items,function(item){_.isString(item)&&(item={key:item}),node.appendChild(this.buildFromLayout(item))},this),node},formTree.prototype.computeInitialValues=function(){this.root.computeInitialValues(this.formDesc.value)},formTree.prototype.render=function(domRoot){domRoot&&(this.domRoot=domRoot,this.root.render(),this.hasRequiredField()&&$(domRoot).addClass("jsonform-hasrequired"))},formTree.prototype.forEachElement=function(callback){var f=function(root){for(var i=0;i<root.children.length;i++)callback(root.children[i]),f(root.children[i])};f(this.root)},formTree.prototype.validate=function(noErrorDisplay){var values=jsonform.getFormValue(this.domRoot),errors=!1,options=this.formDesc;if(options.validate!==!1){var validator=!1;if("object"!=typeof options.validate?global.JSONFormValidator&&(validator=global.JSONFormValidator.createEnvironment("json-schema-draft-03")):validator=options.validate,validator){var v=validator.validate(values,this.formDesc.schema);$(this.domRoot).jsonFormErrors(!1,options),v.errors.length&&(errors||(errors=[]),errors=errors.concat(v.errors))}}return errors&&!noErrorDisplay&&(options.displayErrors?options.displayErrors(errors,this.domRoot):$(this.domRoot).jsonFormErrors(errors,options)),{errors:errors}},formTree.prototype.submit=function(evt){var stopEvent=function(){return evt&&(evt.preventDefault(),evt.stopPropagation()),!1},values=jsonform.getFormValue(this.domRoot),options=this.formDesc,brk=!1;if(this.forEachElement(function(elt){brk||elt.view.onSubmit&&(brk=!elt.view.onSubmit(evt,elt))}),brk)return stopEvent();var validated=this.validate();return options.onSubmit&&!options.onSubmit(validated.errors,values)?stopEvent():validated.errors?stopEvent():!(!options.onSubmitValid||options.onSubmitValid(values))&&stopEvent()},formTree.prototype.hasRequiredField=function(){var parseElement=function(element){if(!element)return null;if(element.required&&"boolean"!==element.type)return element;var prop=_.find(element.properties,function(property){return parseElement(property)});return prop?prop:element.items&&(prop=_.isArray(element.items)?_.find(element.items,function(item){return parseElement(item)}):parseElement(element.items))?prop:void 0};return parseElement(this.formDesc.schema)},jsonform.getFormValue=function(formelt){var form=$(formelt).data("jsonform-tree");return form?form.root.getFormValues():null},$.fn.jsonFormErrors=function(errors,options){if($(".error",this).removeClass("error"),$(".warning",this).removeClass("warning"),$(".jsonform-errortext",this).hide(),errors){for(var errorSelectors=[],i=0;i<errors.length;i++){var key=errors[i].uri.replace(/.*#\//,"").replace(/\//g,".").replace(/\.([0-9]+)(?=\.|$)/g,"[$1]"),errormarkerclass=".jsonform-error-"+escapeSelector(key.replace(/\./g,"---"));errorSelectors.push(errormarkerclass);var errorType=errors[i].type||"error";$(errormarkerclass,this).addClass(errorType),$(errormarkerclass+" .jsonform-errortext",this).html(errors[i].message).show()}errorSelectors=errorSelectors.join(",");var firstError=$(errorSelectors).get(0);firstError&&firstError.scrollIntoView&&firstError.scrollIntoView(!0,{behavior:"smooth"})}},$.fn.jsonForm=function(options){var formElt=this;options=_.defaults({},options,{submitEvent:"submit"});var form=new formTree;return form.initialize(options),form.render(formElt.get(0)),options.transloadit&&formElt.append('<input type="hidden" name="params" value=\''+escapeHTML(JSON.stringify(options.transloadit.params))+"'>"),formElt.data("jsonform-tree",form),options.submitEvent&&(formElt.unbind(options.submitEvent+".jsonform"),formElt.bind(options.submitEvent+".jsonform",function(evt){form.submit(evt)})),initializeTabs(formElt),$(".expandable > div, .expandable > fieldset",formElt).hide(),$(".expandable > legend",formElt).click(function(){var parent=$(this).parent();parent.toggleClass("expanded"),$("> div",parent).slideToggle(100)}),form},$.fn.jsonFormValue=function(){return jsonform.getFormValue(this)},global.JSONForm=global.JSONForm||{util:{}},global.JSONForm.getFormValue=jsonform.getFormValue,global.JSONForm.fieldTemplate=jsonform.fieldTemplate,global.JSONForm.fieldTypes=jsonform.elementTypes,global.JSONForm.getInitialValue=getInitialValue,global.JSONForm.util.getObjKey=jsonform.util.getObjKey,global.JSONForm.util.setObjKey=jsonform.util.setObjKey}("undefined"!=typeof exports,"undefined"!=typeof exports?exports:window,"undefined"!=typeof jQuery?jQuery:{fn:{}},"undefined"!=typeof _?_:null,JSON);