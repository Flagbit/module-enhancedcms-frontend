define(["exports","jquery","prototype","../configs/CONSTANTS.min.js","../classes/Widget.min.js","../classes/Container.min.js","../classes/Carousel.min.js","../classes/Toolbar.min.js","jquery/ui","jquery/jquery-storageapi"],function(exports,_jquery,_prototype,_CONSTANTSMin,_WidgetMin,_ContainerMin,_CarouselMin,_ToolbarMin){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _jquery2=_interopRequireDefault(_jquery),_WidgetMin2=(_interopRequireDefault(_prototype),_interopRequireDefault(_WidgetMin)),_ContainerMin2=_interopRequireDefault(_ContainerMin),_CarouselMin2=_interopRequireDefault(_CarouselMin),_ToolbarMin2=_interopRequireDefault(_ToolbarMin),ContentController=function ContentController($rootScope,$scope,$element,CONFIG,$mdPanel,$compile,$interpolate,$templateCache,$templateRequest,$q,$log,$mdDialog,ecmsPanel,ecmsPanelBar,$translate){_classCallCheck(this,ContentController);var contentScope={globalData:{},globalDefaults:{},defaultContentClasses:[],widgets:[],categories:{},pageId:null,baseUrl:null,toolbar:null,toolbarOpen:!1,searchTerm:"",_draggable:!1,init:function(){var _this=this;document.body.classList.add(_CONSTANTSMin.CONSTANTS.BODY_CLASSNAME),this.$element=$element,$rootScope.pageId=CONFIG.pageId,$rootScope.templateBaseUrl=CONFIG.templateBaseUrl,this.globalData=CONFIG.data.global,this.isLoading=!1,$rootScope.pageId=CONFIG.pageId,$rootScope.imageUploadUrl=CONFIG.imageUploadUrl,$rootScope.widgetData=CONFIG.builderConfig,$rootScope.fileQueue={},$rootScope.productListUrl=CONFIG.productListUrl,$rootScope.saveUrl=CONFIG.saveUrl,$rootScope.findWidgetByElement=function(widgetEl){var name=(0,_jquery2["default"])(widgetEl).attr("data-widget");return $rootScope.findWidgetByName(name)},$rootScope.findWidgetByName=function(name){return $rootScope.widgets.find(function(widget){return widget.getName()==name})},$rootScope.$safeApply=function(scope){"$apply"!=$rootScope.$$phase&&"$digest"!=$rootScope.$$phase&&scope.$apply()};var widgets=CONFIG.data.widgets;this.widgets=[],_jquery2["default"].each(widgets,function(i,widget){"container"==widget.type?_this.widgets.push(new _ContainerMin2["default"](_this,$templateCache,$q,$interpolate,$compile,$mdDialog,widget,CONFIG.widgetUrl,_this.globalData)):"carousel"==widget.type?_this.widgets.push(new _CarouselMin2["default"](_this,$templateCache,$q,$interpolate,$compile,$mdDialog,widget,CONFIG.widgetUrl,_this.globalData)):_this.widgets.push(new _WidgetMin2["default"](_this,$templateCache,$q,$interpolate,$compile,$mdDialog,widget,CONFIG.widgetUrl,_this.globalData))}),$rootScope.widgets=this.widgets,$rootScope.toolbarTemplateUrl=$rootScope.templateBaseUrl+"/widget-toolbar.html",this.toolbar=new _ToolbarMin2["default"]("",this,$compile,$templateCache,$templateRequest),this.initEvents(),this.initGlobalDefaults(),this.initCategories(),$rootScope.categories=this.categories,this.initSortable(),ecmsPanelBar.initialize()},initEvents:function(){$rootScope.$on("startProcess",this.startProcess.bind(this)),$rootScope.$on("stopProcess",this.stopProcess.bind(this))},startProcess:function(){this.isLoading=!0},stopProcess:function(){this.isLoading=!1},initGlobalDefaults:function(){var _this2=this;this.globalData.config&&_jquery2["default"].each(this.globalData.config,function(i,config){if(config.options){var options=config.options;options.value&&(_this2.globalDefaults[i]||(_this2.globalDefaults[i]=options.value),options.contentClass&&_this2.defaultContentClasses.push(options.value))}})},initCategories:function(){var _this3=this;_jquery2["default"].each(this.widgets,function(i,widget){widget.getCategory()||widget.setCategory("Uncategorized");var categories=widget.getCategory().split(",");_jquery2["default"].each(categories,function(i,category){_this3.categories[category]?_this3.categories[category].count++:_this3.categories[category]={title:category,count:1,value:category}})})},onWidgetDrag:function(ev,ui){ui.helper.addClass("ecms-widget-dragging"),$rootScope.hoverDisabled=!0},onWidgetDrop:function(ev,ui){if(!ui.draggable&&ui.item&&(ui.draggable=ui.item),!ui.helper&&ui.item&&(ui.helper=ui.item),ui.draggable.hasClass("ui-draggable")){var widget=$rootScope.findWidgetByElement(ui.helper),attributes=_jquery2["default"].map(ui.draggable.get(0).attributes,function(item){return item.name});_jquery2["default"].each(attributes,function(i,item){"data-widget"!=item&&ui.draggable.removeAttr(item)}),widget.isContainer()?(ui.draggable.addClass("ecms-container-widget-directive"),ui.draggable.addClass("ecms-widget-container")):widget.isCarousel()?(ui.draggable.addClass("ecms-carousel-widget-directive"),ui.draggable.addClass("ecms-widget-carousel")):ui.draggable.addClass("ecms-widget-directive"),ui.draggable.addClass("ecms-widget-initialize").attr("ng-click","ctrl.click($event)").html(""),ui.draggable.replaceWith($compile(ui.draggable.get(0).outerHTML)($scope))}},initSortable:function(){var _this4=this;(0,_jquery2["default"])("#ecms-page-content").sortable({handle:".ecms-toolbar-handle",placeholder:"ecms-widget-placeholder",connectWith:".ecms-widget-container-item-empty",start:function(e,ui){ui.placeholder.height(ui.item.height()),$rootScope.hoverDisabled=!0},stop:function(ev,ui){ui.item.hasClass("ui-draggable")&&_this4.onWidgetDrop(ev,ui),$rootScope.hoverDisabled=!1}})}};Object.assign($scope,contentScope),$scope.init()};exports["default"]=ContentController});