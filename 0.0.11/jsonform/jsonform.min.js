!function(serverside,global,$,_,JSON){serverside&&!_&&(_=require("underscore"));var getDefaultClasses=function(isBootstrap2){return isBootstrap2?{groupClass:"control-group",groupMarkClassPrefix:"",labelClass:"control-label",controlClass:"controls",iconClassPrefix:"icon",buttonClass:"btn",textualInputClass:"",prependClass:"input-prepend",appendClass:"input-append",addonClass:"add-on",inlineClassSuffix:" inline"}:{groupClass:"form-group",groupMarkClassPrefix:"has-",labelClass:"control-label",controlClass:"controls",iconClassPrefix:"glyphicon glyphicon",buttonClass:"btn btn-default",textualInputClass:"form-control",prependClass:"input-group",appendClass:"input-group",addonClass:"input-group-addon",buttonAddonClass:"input-group-btn",inlineClassSuffix:"-inline"}},reArray=/\[([0-9]*)\](?=\[|\.|$)/g,fieldTemplateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g},valueTemplateSettings={evaluate:/\{\[([\s\S]+?)\]\}/g,interpolate:/\{\{([\s\S]+?)\}\}/g},_template="string"==typeof _.template("",{})?_.template:function(tmpl,data,opts){return _.template(tmpl,opts)(data)},isSet=function(value){return!(_.isUndefined(value)||_.isNull(value))},hasOwnProperty=function(obj,prop){return"object"==typeof obj&&Object.prototype.hasOwnProperty.call(obj,prop)},jsonform={util:{}},escapeHTML=function(string){return isSet(string)?(string=""+string,string?string.replace(/&(?!\w+;|#\d+;|#x[\da-f]+;)/gi,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):""):""},escapeSelector=function(selector){return selector.replace(/([ \!\"\#\$\%\&\'\(\)\*\+\,\.\/\:\;<\=\>\?\@\[\\\]\^\`\{\|\}\~])/g,"\\$1")},initializeTabs=function(tabs){var activate=function(element,container){container.find("> .active").removeClass("active"),element.addClass("active")},enableFields=function($target,targetIndex){$target.find("input, textarea, select").removeAttr("disabled"),$target.parent().children(":not([data-idx="+targetIndex+"])").find("input, textarea, select").attr("disabled","disabled")},optionSelected=function(e){var $target,$option=$("option:selected",$(this)),$select=$(this),targetIdx=$option.get(0).getAttribute("data-idx")||$option.attr("value");e.preventDefault(),$option.hasClass("active")||($target=$(this).parents(".tabbable").eq(0).find("> .tab-content > [data-idx="+targetIdx+"]"),activate($option,$select),activate($target,$target.parent()),enableFields($target,targetIdx))},tabClicked=function(e){var $content=($("a",$(this)),$(this).parents(".tabbable").first().find(".tab-content").first()),targetIdx=$(this).index(),$target=$content.find("> [data-idx="+targetIdx+"]");e.preventDefault(),activate($(this),$(this).parent()),activate($target,$target.parent()),$(this).parent().hasClass("jsonform-alternative")&&enableFields($target,targetIdx)};tabs.each(function(){$(this).delegate("select.nav","change",optionSelected),$(this).find("select.nav").each(function(){$(this).val($(this).find(".active").attr("value"));var targetIdx=$(this).find("option:selected").get(0).getAttribute("data-idx")||$(this).find("option:selected").attr("value"),$target=$(this).parents(".tabbable").eq(0).find("> .tab-content > [data-idx="+targetIdx+"]");enableFields($target,targetIdx)}),$(this).delegate("ul.nav li","click",tabClicked),$(this).find("ul.nav li.active").click()})};jsonform.fieldTemplate=function(inner){return'<div class="<%= cls.groupClass %> jsonform-node jsonform-error-<%= keydash %><%= elt.htmlClass ? " " + elt.htmlClass : "" %><%= (node.required && node.formElement && (node.formElement.type !== "checkbox") ? " jsonform-required" : "") %><%= (node.isReadOnly() ? " jsonform-readonly" : "") %><%= (node.disabled ? " jsonform-disabled" : "") %>" data-jsonform-type="<%= node.formElement.type %>"><% if (node.title && !elt.notitle && elt.inlinetitle !== true) { %><label class="<%= cls.labelClass %>" for="<%= node.id %>"><%= node.title %></label><% } %><div class="<%= cls.controlClass %>"><% if (node.description) { %><span class="help-block jsonform-description"><%= node.description %></span><% } %><% if (node.prepend || node.append) { %><div class="<%= node.prepend ? cls.prependClass : "" %> <%= node.append ? cls.appendClass : "" %>"><% if (node.prepend && node.prepend.indexOf("<button ") >= 0) { %><% if (cls.buttonAddonClass) { %><span class="<%= cls.buttonAddonClass %>"><%= node.prepend %></span><% } else { %><%= node.prepend %><% } %><% } %><% if (node.prepend && node.prepend.indexOf("<button ") < 0) { %><span class="<%= cls.addonClass %>"><%= node.prepend %></span><% } %><% } %>'+inner+'<% if (node.append && node.append.indexOf("<button ") >= 0) { %><% if (cls.buttonAddonClass) { %><span class="<%= cls.buttonAddonClass %>"><%= node.append %></span><% } else { %><%= node.append %><% } %><% } %><% if (node.append && node.append.indexOf("<button ") < 0) { %><span class="<%= cls.addonClass %>"><%= node.append %></span><% } %><% if (node.prepend || node.append) { %></div><% } %><span class="help-block jsonform-errortext" style="display:none;"></span></div></div>'};var fileDisplayTemplate='<div class="_jsonform-preview"><% if (value.type=="image") { %><img class="jsonform-preview" id="jsonformpreview-<%= id %>" src="<%= value.url %>" /><% } else { %><a href="<%= value.url %>"><%= value.name %></a> (<%= Math.ceil(value.size/1024) %>kB)<% } %></div><a href="#" class="<%= cls.buttonClass %> _jsonform-delete"><i class="<%= cls.iconClassPrefix %>-remove" title="Remove"></i></a> ',inputFieldTemplate=function(type,isTextualInput,extraOpts){var templ={template:'<input type="'+type+'" class="<%= fieldHtmlClass'+(isTextualInput?" || cls.textualInputClass":"")+' %>" name="<%= node.name %>" value="<%= escape(value) %>" id="<%= id %>"<%= (node.disabled? " disabled" : "")%><%= (node.isReadOnly() ? " readonly=\'readonly\'" : "") %><%= (node.schemaElement && node.schemaElement.maxLength ? " maxlength=\'" + node.schemaElement.maxLength + "\'" : "") %><%= (node.required ? " required=\'required\'" : "") %><%= (node.placeholder? " placeholder=" + \'"\' + escape(node.placeholder) + \'"\' : "")%> />',fieldtemplate:!0,inputfield:!0,onInsert:function(evt,node){if(node.formElement&&node.formElement.autocomplete){var $input=$(node.el).find("input");$input.autocomplete&&$input.autocomplete(node.formElement.autocomplete)}if(node.formElement&&(node.formElement.tagsinput||"tagsvalue"===node.formElement.getValue)){if(!$.fn.tagsinput)throw new Error("tagsinput is not found");var $input=$(node.el).find("input"),isArray=Array.isArray(node.value);isArray&&$input.attr("value","").val(""),$input.tagsinput(node.formElement?node.formElement.tagsinput||{}:{}),isArray&&node.value.forEach(function(value){$input.tagsinput("add",value)})}if(node.formElement&&node.formElement.typeahead){var $input=$(node.el).find("input");if($input.typeahead)if(Array.isArray(node.formElement.typeahead)){for(var i=1;i<node.formElement.typeahead.length;++i){var dataset=node.formElement.typeahead[i];if(dataset.source&&Array.isArray(dataset.source)){var source=dataset.source;dataset.source=function(query,cb){var lq=query.toLowerCase();cb(source.filter(function(v){return v.toLowerCase().indexOf(lq)>=0}).map(function(v){return"string"==typeof v?{value:v}:v}))}}}$.fn.typeahead.apply($input,node.formElement.typeahead)}else $input.typeahead(node.formElement.typeahead)}}};return extraOpts&&(templ=_.extend(templ,extraOpts)),templ},numberFieldTemplate=function(type,isTextualInput){return{template:'<input type="'+type+'" class="<%= fieldHtmlClass'+(isTextualInput?" || cls.textualInputClass":"")+' %>" name="<%= node.name %>" value="<%= escape(value) %>" id="<%= id %>"<%= (node.disabled? " disabled" : "")%><%= (node.isReadOnly() ? " readonly=\'readonly\'" : "") %><%= (range.min !== undefined ? " min="+range.min : "")%><%= (range.max !== undefined ? " max="+range.max : "")%><%= (range.step !== undefined ? " step="+range.step : "")%><%= (node.schemaElement && node.schemaElement.maxLength ? " maxlength=\'" + node.schemaElement.maxLength + "\'" : "") %><%= (node.required ? " required=\'required\'" : "") %><%= (node.placeholder? " placeholder=" + \'"\' + escape(node.placeholder) + \'"\' : "")%> />',fieldtemplate:!0,inputfield:!0,onBeforeRender:function(data,node){if(data.range={step:1},"range"==type&&(data.range.min=1,data.range.max=100),node&&node.schemaElement){node.formElement&&node.formElement.step?data.range.step=node.formElement.step:"number"==node.schemaElement.type&&(data.range.step="any");var step="any"===data.range.step?1:data.range.step;"undefined"!=typeof node.schemaElement.minimum&&(node.schemaElement.exclusiveMinimum?data.range.min=node.schemaElement.minimum+step:data.range.min=node.schemaElement.minimum),"undefined"!=typeof node.schemaElement.maximum&&(node.schemaElement.exclusiveMaximum?data.range.max=node.schemaElement.maximum-step:data.range.max=node.schemaElement.maximum)}}}};jsonform.elementTypes={none:{template:""},root:{template:"<div><%= children %></div>"},text:inputFieldTemplate("text",!0),password:inputFieldTemplate("password",!0),date:inputFieldTemplate("date",!0,{onInsert:function(evt,node){if(window.Modernizr&&window.Modernizr.inputtypes&&!window.Modernizr.inputtypes.date){var $input=$(node.el).find("input");if($input.datepicker){var opt={dateFormat:"yy-mm-dd"};node.formElement&&node.formElement.datepicker&&"object"==typeof node.formElement.datepicker&&_.extend(opt,node.formElement.datepicker),$input.datepicker(opt)}}}}),datetime:inputFieldTemplate("datetime",!0),"datetime-local":inputFieldTemplate("datetime-local",!0,{onBeforeRender:function(data,node){data.value&&data.value.getTime&&(data.value=new Date(data.value.getTime()-6e4*data.value.getTimezoneOffset()).toISOString().slice(0,-1))}}),email:inputFieldTemplate("email",!0),month:inputFieldTemplate("month",!0),number:numberFieldTemplate("number",!0),search:inputFieldTemplate("search",!0),tel:inputFieldTemplate("tel",!0),time:inputFieldTemplate("time",!0),url:inputFieldTemplate("url",!0),week:inputFieldTemplate("week",!0),range:numberFieldTemplate("range"),color:{template:'<input type="text" <%= (fieldHtmlClass ? "class=\'" + fieldHtmlClass + "\' " : "") %>name="<%= node.name %>" value="<%= escape(value) %>" id="<%= id %>"<%= (node.disabled? " disabled" : "")%><%= (node.required ? " required=\'required\'" : "") %> />',fieldtemplate:!0,inputfield:!0,onInsert:function(evt,node){$(node.el).find("#"+escapeSelector(node.id)).spectrum({preferredFormat:"hex",showInput:!0})}},textarea:{template:'<textarea id="<%= id %>" name="<%= node.name %>" class="<%= fieldHtmlClass || cls.textualInputClass %>" style="<%= elt.height ? "height:" + elt.height + ";" : "" %>width:<%= elt.width || "100%" %>;"<%= (node.disabled? " disabled" : "")%><%= (node.isReadOnly() ? " readonly=\'readonly\'" : "") %><%= (node.schemaElement && node.schemaElement.maxLength ? " maxlength=\'" + node.schemaElement.maxLength + "\'" : "") %><%= (node.required ? " required=\'required\'" : "") %><%= (node.placeholder? " placeholder=" + \'"\' + escape(node.placeholder) + \'"\' : "")%>><%= value %></textarea>',fieldtemplate:!0,inputfield:!0},wysihtml5:{template:'<textarea id="<%= id %>" name="<%= node.name %>" style="height:<%= elt.height || "300px" %>;width:<%= elt.width || "100%" %>;"<%= (node.disabled? " disabled" : "")%><%= (node.isReadOnly() ? " readonly=\'readonly\'" : "") %><%= (node.schemaElement && node.schemaElement.maxLength ? " maxlength=\'" + node.schemaElement.maxLength + "\'" : "") %><%= (node.required ? " required=\'required\'" : "") %><%= (node.placeholder? " placeholder=" + \'"\' + escape(node.placeholder) + \'"\' : "")%>><%= value %></textarea>',fieldtemplate:!0,inputfield:!0,onInsert:function(evt,node){var setup=function(){$(node.el).data("wysihtml5")||($(node.el).data("wysihtml5_loaded",!0),$(node.el).find("#"+escapeSelector(node.id)).wysihtml5({html:!0,link:!0,"font-styles":!0,image:!0,events:{load:function(){$(this.textareaElement).removeAttr("required")}}}))};if(window.jsonform_wysihtml5_setup)return void window.jsonform_wysihtml5_setup(setup);var itv=window.setInterval(function(){window.wysihtml5&&(window.clearInterval(itv),setup())},1e3)}},ace:{template:'<div id="<%= id %>" style="position:relative;height:<%= elt.height || "300px" %>;"><div id="<%= id %>__ace" style="width:<%= elt.width || "100%" %>;height:<%= elt.height || "300px" %>;"></div><input type="hidden" name="<%= node.name %>" id="<%= id %>__hidden" value="<%= escape(value) %>"/></div>',fieldtemplate:!0,inputfield:!0,onBeforeRender:function(data,node){(data.value&&"object"==typeof data.value||Array.isArray(data.value))&&(data.value=JSON.stringify(data.value,null,2))},onInsert:function(evt,node){var setup=function(){var formElement=node.formElement||{},ace=window.ace,editor=ace.edit($(node.el).find("#"+escapeSelector(node.id)+"__ace").get(0)),idSelector="#"+escapeSelector(node.id)+"__hidden";editor.getSession().setNewLineMode("unix"),editor.renderer.setShowPrintMargin(!1),editor.setTheme("ace/theme/"+(formElement.aceTheme||"twilight")),formElement.aceMode&&editor.getSession().setMode("ace/mode/"+formElement.aceMode),editor.getSession().setTabSize(2);var valueStr=node.value;null===valueStr||void 0===valueStr?valueStr="":("object"==typeof valueStr||Array.isArray(valueStr))&&(valueStr=JSON.stringify(valueStr,null,2)),editor.getSession().setValue(valueStr);var lazyChanged=_.debounce(function(){$(node.el).find(idSelector).val(editor.getSession().getValue()),$(node.el).find(idSelector).change()},600);editor.getSession().on("change",lazyChanged),editor.on("blur",function(){$(node.el).find(idSelector).change(),$(node.el).find(idSelector).trigger("blur")}),editor.on("focus",function(){$(node.el).find(idSelector).trigger("focus")})};if(window.jsonform_ace_setup)return void window.jsonform_ace_setup(setup);var itv=window.setInterval(function(){window.ace&&(window.clearInterval(itv),setup())},1e3)}},checkbox:{template:'<div class="checkbox"><label><input type="checkbox" id="<%= id %>" name="<%= node.name %>" value="1" <% if (value) {%>checked<% } %><%= (node.disabled? " disabled" : "")%><%= (node.required && node.schemaElement && (node.schemaElement.type !== "boolean") ? " required=\'required\'" : "") %> /><span><%= (node.inlinetitle === true ? node.title : node.inlinetitle) || "" %></span></label></div>',fieldtemplate:!0,inputfield:!0,onInsert:function(evt,node){if(node.formElement.toggleNext){var nextN=node.formElement.toggleNext===!0?1:node.formElement.toggleNext,toggleNextClass="jsonform-toggle-next jsonform-toggle-next-"+nextN,$next=1===nextN?$(node.el).next():"all"===nextN?$(node.el).nextAll():$(node.el).nextAll().slice(0,nextN);$next.addClass("jsonform-toggle-next-target"),$(node.el).addClass(toggleNextClass).find(":checkbox").on("change",function(){var $this=$(this),checked=$this.is(":checked");$(node.el).toggleClass("checked",checked),$next.toggle(checked).toggleClass("jsonform-toggled-visible",checked)}).change()}},getElement:function(el){return $(el).parent().parent().get(0)}},file:{template:'<input class="input-file" id="<%= id %>" name="<%= node.name %>" type="file" <%= (node.required ? " required=\'required\'" : "") %>/>',fieldtemplate:!0,inputfield:!0},"file-hosted-public":{template:"<span><% if (value && (value.type||value.url)) { %>"+fileDisplayTemplate+'<% } %><input class="input-file" id="_transloadit_<%= id %>" type="file" name="<%= transloaditname %>" /><input data-transloadit-name="_transloadit_<%= transloaditname %>" type="hidden" id="<%= id %>" name="<%= node.name %>" value=\'<%= escape(JSON.stringify(node.value)) %>\' /></span>',fieldtemplate:!0,inputfield:!0,getElement:function(el){return $(el).parent().get(0)},onBeforeRender:function(data,node){node.ownerTree._transloadit_generic_public_index?node.ownerTree._transloadit_generic_public_index++:node.ownerTree._transloadit_generic_public_index=1,data.transloaditname="_transloadit_jsonform_genericupload_public_"+node.ownerTree._transloadit_generic_public_index,node.ownerTree._transloadit_generic_elts||(node.ownerTree._transloadit_generic_elts={}),node.ownerTree._transloadit_generic_elts[data.transloaditname]=node},onChange:function(evt,elt){if(elt.ownerTree._transloadit_bound)return!1;elt.ownerTree._transloadit_bound=!0;var formElt=$(elt.ownerTree.domRoot);formElt.transloadit({autoSubmit:!1,wait:!0,onSuccess:function(assembly){var results=_.values(assembly.results);results=_.flatten(results),_.each(results,function(result){var id=elt.ownerTree._transloadit_generic_elts[result.field].id,input=formElt.find("#"+escapeSelector(id)),nonEmptyKeys=_.filter(_.keys(result.meta),function(key){return!!isSet(result.meta[key])});result.meta=_.pick(result.meta,nonEmptyKeys),input.val(JSON.stringify(result))}),elt.ownerTree._transloadit_bound=!1,formElt.unbind("submit.transloadit"),_.delay(function(){console.log("submit form"),elt.ownerTree.submit()},10)},onError:function(assembly){console.log("assembly error",assembly)}})},onInsert:function(evt,node){$(node.el).find("a._jsonform-delete").on("click",function(evt){return $(node.el).find("._jsonform-preview").remove(),$(node.el).find("a._jsonform-delete").remove(),$(node.el).find("#"+escapeSelector(node.id)).val(""),evt.preventDefault(),!1})},onSubmit:function(evt,elt){return!elt.ownerTree._transloadit_bound}},"file-transloadit":{template:"<span><% if (value && (value.type||value.url)) { %>"+fileDisplayTemplate+'<% } %><input class="input-file" id="_transloadit_<%= id %>" type="file" name="_transloadit_<%= node.name %>" /><input type="hidden" id="<%= id %>" name="<%= node.name %>" value=\'<%= escape(JSON.stringify(node.value)) %>\' /></span>',fieldtemplate:!0,inputfield:!0,getElement:function(el){return $(el).parent().get(0)},onChange:function(evt,elt){if(elt.ownerTree._transloadit_bound)return!1;elt.ownerTree._transloadit_bound=!0;var formElt=$(elt.ownerTree.domRoot);formElt.transloadit({autoSubmit:!1,wait:!0,onSuccess:function(assembly){var results=_.values(assembly.results);results=_.flatten(results),_.each(results,function(result){var input=formElt.find('input[name="'+result.field.replace(/^_transloadit_/,"")+'"]'),nonEmptyKeys=_.filter(_.keys(result.meta),function(key){return!!isSet(result.meta[key])});result.meta=_.pick(result.meta,nonEmptyKeys),input.val(JSON.stringify(result))}),elt.ownerTree._transloadit_bound=!1,formElt.unbind("submit.transloadit"),_.delay(function(){console.log("submit form"),elt.ownerTree.submit()},10)},onError:function(assembly){console.log("assembly error",assembly)}})},onInsert:function(evt,node){$(node.el).find("a._jsonform-delete").on("click",function(evt){return $(node.el).find("._jsonform-preview").remove(),$(node.el).find("a._jsonform-delete").remove(),$(node.el).find("#"+escapeSelector(node.id)).val(""),evt.preventDefault(),!1})},onSubmit:function(evt,elt){return!elt.ownerTree._transloadit_bound}},select:{template:'<select name="<%= node.name %>" id="<%= id %>" class="<%= fieldHtmlClass || cls.textualInputClass %>"<%= (node.disabled? " disabled" : "")%><%= (node.required ? " required=\'required\'" : "") %>> <% _.each(node.options, function(key, val) { if(key instanceof Object) { if (value === key.value) { %> <option selected value="<%= key.value %>"><%= key.title %></option> <% } else { %> <option value="<%= key.value %>"><%= key.title %></option> <% }} else { if (value === key) { %> <option selected value="<%= key %>"><%= key %></option> <% } else { %><option value="<%= key %>"><%= key %></option> <% }}}); %> </select>',fieldtemplate:!0,inputfield:!0},tagsinput:{template:'<select name="<%= node.name %><%= node.formElement.getValue === "tagsinput" ? "" : "[]" %>" id="<%= id %>" class="<%= fieldHtmlClass || cls.textualInputClass %>" multiple<%= (node.disabled? " disabled" : "")%><%= (node.required ? " required=\'required\'" : "") %>> </select>',fieldtemplate:!0,inputfield:!0,onInsert:function(evt,node){if(!$.fn.tagsinput)throw new Error("tagsinput is not found");var $input=$(node.el).find("select");$input.tagsinput(node.formElement?node.formElement.tagsinput||{}:{}),node.value&&node.value.forEach(function(value){$input.tagsinput("add",value)})}},imageselect:{template:'<div><input type="hidden" name="<%= node.name %>" id="<%= node.id %>" value="<%= value %>" /><div class="dropdown"><a class="<%= node.value ? buttonClass : cls.buttonClass %>" data-toggle="dropdown" href="#"<% if (node.value) { %> style="max-width:<%= width %>px;max-height:<%= height %>px"<% } %>><% if (node.value) { %><img src="<% if (!node.value.match(/^https?:/)) { %><%= prefix %><% } %><%= node.value %><%= suffix %>" alt="" /><% } else { %><%= buttonTitle %><% } %></a><div class="dropdown-menu navbar" id="<%= node.id %>_dropdown"><div><% _.each(node.options, function(key, idx) { if ((idx > 0) && ((idx % columns) === 0)) { %></div><div><% } %><a class="<%= buttonClass %>" style="max-width:<%= width %>px;max-height:<%= height %>px"><% if (key instanceof Object) { %><img src="<% if (!key.value.match(/^https?:/)) { %><%= prefix %><% } %><%= key.value %><%= suffix %>" alt="<%= key.title %>" /></a><% } else { %><img src="<% if (!key.match(/^https?:/)) { %><%= prefix %><% } %><%= key %><%= suffix %>" alt="" /><% } %></a> <% }); %></div><div class="pagination-right"><a class="<%= cls.buttonClass %>">Reset</a></div></div></div></div>',fieldtemplate:!0,inputfield:!0,onBeforeRender:function(data,node){var elt=node.formElement||{},nbRows=null,maxColumns=elt.imageSelectorColumns||5;data.buttonTitle=elt.imageSelectorTitle||"Select...",data.prefix=elt.imagePrefix||"",data.suffix=elt.imageSuffix||"",data.width=elt.imageWidth||32,data.height=elt.imageHeight||32,data.buttonClass=elt.imageButtonClass||data.cls.buttonClass,node.options.length>maxColumns?(nbRows=Math.ceil(node.options.length/maxColumns),data.columns=Math.ceil(node.options.length/nbRows)):data.columns=maxColumns},getElement:function(el){return $(el).parent().get(0)},onInsert:function(evt,node){$(node.el).on("click",".dropdown-menu a",function(evt){evt.preventDefault(),evt.stopPropagation();var img="img"===evt.target.nodeName.toLowerCase()?$(evt.target):$(evt.target).find("img"),value=img.attr("src"),elt=node.formElement||{},prefix=elt.imagePrefix||"",suffix=elt.imageSuffix||"",width=elt.imageWidth||32,height=elt.imageHeight||32;value?(0===value.indexOf(prefix)&&(value=value.substring(prefix.length)),value=value.substring(0,value.length-suffix.length),$(node.el).find("input").attr("value",value),$(node.el).find('a[data-toggle="dropdown"]').addClass(elt.imageButtonClass).attr("style","max-width:"+width+"px;max-height:"+height+"px").html('<img src="'+(value.match(/^https?:/)?"":prefix)+value+suffix+'" alt="" />')):($(node.el).find("input").attr("value",""),$(node.el).find('a[data-toggle="dropdown"]').removeClass(elt.imageButtonClass).removeAttr("style").html(elt.imageSelectorTitle||"Select..."))})}},iconselect:{template:'<div><input type="hidden" name="<%= node.name %>" id="<%= node.id %>" value="<%= value %>" /><div class="dropdown"><a class="<%= node.value ? buttonClass : cls.buttonClass %>" data-toggle="dropdown" href="#"<% if (node.value) { %> style="max-width:<%= width %>px;max-height:<%= height %>px"<% } %>><% if (node.value) { %><i class="<%= cls.iconClassPrefix %>-<%= node.value %>" /><% } else { %><%= buttonTitle %><% } %></a><div class="dropdown-menu navbar" id="<%= node.id %>_dropdown"><div><% _.each(node.options, function(key, idx) { if ((idx > 0) && ((idx % columns) === 0)) { %></div><div><% } %><a class="<%= buttonClass %>" ><% if (key instanceof Object) { %><i class="<%= cls.iconClassPrefix %>-<%= key.value %>" alt="<%= key.title %>" /></a><% } else { %><i class="<%= cls.iconClassPrefix %>-<%= key %>" alt="" /><% } %></a> <% }); %></div><div class="pagination-right"><a class="<%= cls.buttonClass %>">Reset</a></div></div></div></div>',fieldtemplate:!0,inputfield:!0,onBeforeRender:function(data,node){var elt=node.formElement||{},nbRows=null,maxColumns=elt.imageSelectorColumns||5;data.buttonTitle=elt.imageSelectorTitle||"Select...",data.buttonClass=elt.imageButtonClass||data.cls.buttonClass,node.options.length>maxColumns?(nbRows=Math.ceil(node.options.length/maxColumns),data.columns=Math.ceil(node.options.length/nbRows)):data.columns=maxColumns},getElement:function(el){return $(el).parent().get(0)},onInsert:function(evt,node){$(node.el).on("click",".dropdown-menu a",function(evt){evt.preventDefault(),evt.stopPropagation();var i="i"===evt.target.nodeName.toLowerCase()?$(evt.target):$(evt.target).find("i"),value=i.attr("class"),elt=node.formElement||{};value?(value=value,$(node.el).find("input").attr("value",value),$(node.el).find('a[data-toggle="dropdown"]').addClass(elt.imageButtonClass).html('<i class="'+value+'" alt="" />')):($(node.el).find("input").attr("value",""),$(node.el).find('a[data-toggle="dropdown"]').removeClass(elt.imageButtonClass).html(elt.imageSelectorTitle||"Select..."))})}},radios:{template:'<div id="<%= node.id %>"><% _.each(node.options, function(key, val) { %><% if (!elt.inline) { %><div class="radio"><label><% } else { %><label class="radio<%= cls.inlineClassSuffix %>"><% } %><input type="radio" <% if (((key instanceof Object) && (value === key.value)) || (value === key)) { %> checked="checked" <% } %> name="<%= node.name %>" value="<%= (key instanceof Object ? key.value : key) %>"<%= (node.disabled? " disabled" : "")%><%= (node.required ? " required=\'required\'" : "") %>/><span><%= (key instanceof Object ? key.title : key) %></span></label><%= elt.inline ? "" : "</div>" %> <% }); %></div>',fieldtemplate:!0,inputfield:!0,onInsert:function(evt,node){if(node.formElement.toggleNextMap){var valueMapToNext={};for(var value in node.formElement.toggleNextMap){var toggleNext=node.formElement.toggleNextMap[value],nextN=toggleNext===!0?1:toggleNext,toggleNextClass="jsonform-toggle-next jsonform-toggle-next-"+nextN,$next=1===nextN?$(node.el).next():"all"===nextN?$(node.el).nextAll():$(node.el).nextAll().slice(0,nextN);$next.addClass("jsonform-toggle-next-target"),valueMapToNext[value]=$next}$(node.el).addClass(toggleNextClass).find(":radio").on("change",function(){var $this=$(this),val=$this.val(),checked=$this.is(":checked");if(checked)for(var v in valueMapToNext){var $n=valueMapToNext[v];v===val?$n.toggle(checked).toggleClass("jsonform-toggled-visible",checked):$n.toggle(!checked).toggleClass("jsonform-toggled-visible",!checked)}else for(var v in valueMapToNext){var $n=valueMapToNext[v];$n.toggle(!1).toggleClass("jsonform-toggled-visible",!1)}}).change()}}},radiobuttons:{template:'<div id="<%= node.id %>"  class="<%= elt.htmlClass ? " " + elt.htmlClass : "" %>"><% _.each(node.options, function(key, val) { %><label class="<%= cls.buttonClass %>"><input type="radio" style="position:absolute;left:-9999px;" <% if (((key instanceof Object) && (value === key.value)) || (value === key)) { %> checked="checked" <% } %> name="<%= node.name %>" value="<%= (key instanceof Object ? key.value : key) %>" /><span><%= (key instanceof Object ? key.title : key) %></span></label> <% }); %></div>',fieldtemplate:!0,inputfield:!0,onInsert:function(evt,node){var activeClass="active",elt=node.formElement||{};elt.activeClass&&(activeClass+=" "+elt.activeClass),$(node.el).find("label").on("click",function(){$(this).parent().find("label").removeClass(activeClass),$(this).addClass(activeClass)}).find(":checked").closest("label").addClass(activeClass)}},checkboxes:{template:'<div id="<%= node.id %>"><%= choiceshtml %><%= children %></div>',fieldtemplate:!0,inputfield:!0,childTemplate:function(inner,node){if(!node.formElement.otherField)return inner;var template="";node.formElement.otherField.asArrayValue&&node.otherValues&&(template+='<% value = node.parentNode.otherValues.join(", ") %>'),template+='<input type="checkbox"<%= value !== undefined && value !== null && value !== "" ? " checked=\'checked\'" : "" %>',(!node.formElement.otherField.asArrayValue&&node.formElement.otherField.novalue!==!0||node.formElement.otherField.novalue===!1)&&(template+=' name="'+node.key+"["+(void 0!==node.formElement.otherField.idx?node.formElement.otherField.idx:node.formElement.options.length)+']" value="'+(node.formElement.optionsAsEnumOrder?1:node.formElement.otherField.otherValue||"OTHER")+'"'),template+='<%= node.disabled? " disabled" : "" %> />',template+='<span><%= node.title || "Other" %> </span>';var otherFieldClass="other-field";return node.formElement.otherField.inline&&(template+='<div class="other-field-content">'+inner+"</div>",otherFieldClass="inline-"+otherFieldClass),template=node.formElement.inline?'<label class="'+otherFieldClass+' checkbox<%= cls.inlineClassSuffix %>">'+template+"</label>":'<div class="'+otherFieldClass+' checkbox"><label>'+template+"</label></div>",node.formElement.otherField.inline||(template+='<div class="other-field-content">'+inner+"</div>"),template},onBeforeRender:function(data,node){if(node&&node.schemaElement&&node.schemaElement.items){var choices=node.formElement.options;if(choices){var template='<input type="checkbox"<%= checked ? " checked=\'checked\'" : "" %> name="<%= name %>" value="<%= escape(value) %>"<%= node.disabled? " disabled" : "" %> /><span><%= title %></span>';template=node.formElement.inline?'<label class="checkbox'+data.cls.inlineClassSuffix+'">'+template+"</label>":'<div class="checkbox"><label>'+template+"</label></div>";var choiceshtml="";if(node.formElement.otherField&&node.formElement.otherField.asArrayValue&&node.value){var choiceValues=choices.map(function(choice){return choice.value}),otherValues=[];node.value.forEach(function(val){_.include(choiceValues,val)||otherValues.push(val)}),otherValues.length>0&&(node.otherValues=otherValues)}else delete node.otherValues;_.each(choices,function(choice,idx){return node.formElement.otherField&&choice.value===(node.formElement.otherField.otherValue||"OTHER")?void(node.formElement.otherField.idx=idx):void(choiceshtml+=_template(template,{name:node.key+"["+idx+"]",value:node.formElement.optionsAsEnumOrder?1:choice.value,checked:_.include(node.value,choice.value),title:choice.title,node:node,escape:escapeHTML},fieldTemplateSettings))}),node.formElement.otherField,data.choiceshtml=choiceshtml}}},onInsert:function(evt,node){function inputHasAnyValue(inputs){var anyValue=!1;return inputs.each(function(){var $input=$(this);if($input.is(":checkbox, :radio")&&$input.prop("checked"))return anyValue=!0,!1;if(!$input.is("button"))return""!==$(this).val()?(anyValue=!0,!1):void 0}),anyValue}function otherFieldValueChange(){$checkbox.prop("checked",inputHasAnyValue($inputs))}var $checkbox=node.formElement.otherField&&node.formElement.otherField.inline?$(node.el).find(".inline-other-field :checkbox").first():$(node.el).find(".other-field :checkbox"),$inputs=$(node.el).find(".other-field-content :input");$inputs.on("keyup",otherFieldValueChange).on("change",otherFieldValueChange).change(),$checkbox.on("change",function(){this.checked?(this.checked=!1,$inputs.not(":checkbox,:radio,button").focus()):$inputs.filter("input[type=text], textarea").val("")})}},checkboxbuttons:{template:'<div id="<%= node.id %>"><%= choiceshtml %></div>',fieldtemplate:!0,inputfield:!0,onBeforeRender:function(data,node){var choices=null,choiceshtml=null,template='<label class="<%= cls.buttonClass %> '+data.fieldHtmlClass+'"><input type="checkbox" style="position:absolute;left:-9999px;" <% if (checked) { %> checked="checked" <% } %> name="<%= name %>" value="<%= value %>"<%= (node.disabled? " disabled" : "")%>/><span><%= title %></span></label>';node&&node.schemaElement&&node.schemaElement.items&&(choices=node.formElement.options,choices&&(node.value&&Array.isArray(node.value)||(node.value=[]),choiceshtml="",_.each(choices,function(choice,idx){choiceshtml+=_template(template,{name:node.key+"["+idx+"]",checked:_.include(node.value,choice.value),value:choice.value,title:choice.title,node:node,cls:data.cls},fieldTemplateSettings)}),data.choiceshtml=choiceshtml))},onInsert:function(evt,node){var activeClass="active",elt=node.formElement||{};elt.activeClass&&(activeClass+=" "+elt.activeClass),
$(node.el).find("label").on("click",function(){$(this).toggleClass(activeClass,$(this).find("input:checkbox").prop("checked"))}).find(":checked").closest("label").addClass(activeClass)}},array:{template:'<div id="<%= id %>"><ul class="_jsonform-array-ul" style="list-style-type:none;"><%= children %></ul><% if (!node.isReadOnly()) { %><span class="_jsonform-array-buttons"><a href="#" class="<%= cls.buttonClass %> _jsonform-array-addmore"><i class="<%= cls.iconClassPrefix %>-plus-sign" title="Add new"></i></a> <a href="#" class="<%= cls.buttonClass %> _jsonform-array-deletelast"><i class="<%= cls.iconClassPrefix %>-minus-sign" title="Delete last"></i></a></span><% } %></div>',fieldtemplate:!0,array:!0,childTemplate:function(inner,node){return!node.isReadOnly()&&$("").sortable?'<li data-idx="<%= node.childPos %>"><span class="draggable line"><i class="<%= cls.iconClassPrefix %>-list" title="Move item"></i></span> <a href="#" class="_jsonform-array-item-delete"><i class="<%= cls.iconClassPrefix %>-remove" title="Remove item"></i></a>'+inner+"</li>":'<li data-idx="<%= node.childPos %>">'+inner+"</li>"},onInsert:function(evt,node){var $nodeid=$(node.el).find("#"+escapeSelector(node.id)),boundaries=node.getArrayBoundaries(),moveNodeTo=function(fromIdx,toIdx){if(fromIdx!==toIdx){var incr=fromIdx<toIdx?1:-1,i=0,parentEl=$("> ul",$nodeid);for(i=fromIdx;i!==toIdx;i+=incr)node.children[i].switchValuesWith(node.children[i+incr]),node.children[i].render(parentEl.get(0)),node.children[i+incr].render(parentEl.get(0));var fromEl=$(node.children[fromIdx].el),toEl=$(node.children[toIdx].el);fromEl.detach(),toEl.detach(),fromIdx<toIdx?(0===fromIdx?parentEl.prepend(fromEl):$(node.children[fromIdx-1].el).after(fromEl),$(node.children[toIdx-1].el).after(toEl)):(0===toIdx?parentEl.prepend(toEl):$(node.children[toIdx-1].el).after(toEl),$(node.children[fromIdx-1].el).after(fromEl))}},addItem=function(idx){if(boundaries.maxItems>=0){var slotNum=boundaries.maxItems-node.children.length;if($nodeid.find("> span > a._jsonform-array-addmore").toggleClass("disabled",slotNum<=1),slotNum<1)return!1}node.insertArrayItem(idx,$("> ul",$nodeid).get(0));var canDelete=node.children.length>boundaries.minItems;$nodeid.find("> span > a._jsonform-array-deletelast").toggleClass("disabled",!canDelete),$nodeid.find("> ul > li > a._jsonform-array-item-delete").toggle(canDelete)},deleteItem=function(idx){var itemNumCanDelete=node.children.length-Math.max(boundaries.minItems,0);return $nodeid.find("> span > a._jsonform-array-deletelast").toggleClass("disabled",itemNumCanDelete<=1),$nodeid.find("> ul > li > a._jsonform-array-item-delete").toggle(itemNumCanDelete>1),!(itemNumCanDelete<1)&&(node.deleteArrayItem(idx),void $nodeid.find("> span > a._jsonform-array-addmore").toggleClass("disabled",boundaries.maxItems>=0&&node.children.length>=boundaries.maxItems))};$("> span > a._jsonform-array-addmore",$nodeid).click(function(evt){evt.preventDefault(),evt.stopPropagation();var idx=node.children.length;addItem(idx)});$("> ul > li",$nodeid).length;if(boundaries.minItems>0)for(var i=node.children.length;i<boundaries.minItems;i++)node.insertArrayItem(node.children.length,$nodeid.find("> ul").get(0));var itemNumCanDelete=node.children.length-Math.max(boundaries.minItems,0);$nodeid.find("> span > a._jsonform-array-deletelast").toggleClass("disabled",itemNumCanDelete<=0),$nodeid.find("> ul > li > a._jsonform-array-item-delete").toggle(itemNumCanDelete>0),$nodeid.find("> span > a._jsonform-array-addmore").toggleClass("disabled",boundaries.maxItems>=0&&node.children.length>=boundaries.maxItems),$("> span > a._jsonform-array-deletelast",$nodeid).click(function(evt){var idx=node.children.length-1;evt.preventDefault(),evt.stopPropagation(),deleteItem(idx)}),$nodeid.on("click","> ul > li > a._jsonform-array-item-delete",function(e){e.preventDefault();var $li=$(e.currentTarget).parent();if($li.parent().parent().attr("id")==node.id){e.stopPropagation();var idx=$li.data("idx");deleteItem(idx)}}),!node.isReadOnly()&&$(node.el).sortable&&($("> ul",$nodeid).sortable(),$("> ul",$nodeid).bind("sortstop",function(event,ui){var idx=$(ui.item).data("idx"),newIdx=$(ui.item).index();moveNodeTo(idx,newIdx)}))}},tabarray:{template:'<div id="<%= id %>"><div class="tabbable tabs-left"><ul class="nav nav-tabs"><%= tabs %></ul><div class="tab-content"><%= children %></div></div></div>',fieldtemplate:!0,array:!0,childTemplate:function(inner){return'<div data-idx="<%= node.childPos %>" class="tab-pane">'+inner+"</div>"},onBeforeRender:function(data,node){data.tabs=""},onInsert:function(evt,node){var $nodeid=$(node.el).find("#"+escapeSelector(node.id)),boundaries=node.getArrayBoundaries(),moveNodeTo=function(fromIdx,toIdx){if(fromIdx!==toIdx){var incr=fromIdx<toIdx?1:-1,i=0,tabEl=$("> .tabbable > .tab-content",$nodeid).get(0);for(i=fromIdx;i!==toIdx;i+=incr)node.children[i].switchValuesWith(node.children[i+incr]),node.children[i].render(tabEl),node.children[i+incr].render(tabEl)}},updateTabs=function(selIdx){var tabs="",activateFirstTab=!1;void 0===selIdx&&(selIdx=$("> .tabbable > .nav-tabs .active",$nodeid).data("idx"),selIdx?selIdx=parseInt(selIdx,10):(activateFirstTab=!0,selIdx=0)),selIdx>=node.children.length&&(selIdx=node.children.length-1),_.each(node.children,function(child,idx){var title=child.legend||child.title||"Item "+(idx+1);tabs+='<li data-idx="'+idx+'"><a class="draggable tab" data-toggle="tab">'+escapeHTML(title),node.isReadOnly()||(tabs+=' <span href="#" class="_jsonform-array-item-delete"><i class="'+node.ownerTree.defaultClasses.iconClassPrefix+'-remove" title="Remove item"></i></span></a>'),tabs+="</li>"}),!node.isReadOnly()&&(boundaries.maxItems<0||node.children.length<boundaries.maxItems)&&(tabs+='<li data-idx="-1"><a class="tab _jsonform-array-addmore" title="'+(node.formElement.addMoreTooltip?escapeHTML(node.formElement.addMoreTooltip):"Add new item")+'"><i class="'+node.ownerTree.defaultClasses.iconClassPrefix+'-plus-sign"></i> '+(node.formElement.addMoreTitle||"New")+"</a></li>"),$("> .tabbable > .nav-tabs",$nodeid).html(tabs);var canDelete=boundaries.minItems>=0&&node.children.length<=boundaries.minItems;$nodeid.find("> .tabbable > .nav-tabs > li > a > ._jsonform-array-item-delete").toggle(!canDelete),activateFirstTab&&$('> .tabbable > .nav-tabs [data-idx="0"]',$nodeid).addClass("active"),$('> .tabbable > .nav-tabs [data-toggle="tab"]',$nodeid).eq(selIdx).click()},deleteItem=function(idx){var itemNumCanDelete=node.children.length-Math.max(boundaries.minItems,0);return $nodeid.find("> a._jsonform-array-deleteitem").toggleClass("disabled",itemNumCanDelete<=1),$nodeid.find("> .tabbable > .nav-tabs > li > a > ._jsonform-array-item-delete").toggle(itemNumCanDelete>1),!(itemNumCanDelete<1)&&(node.deleteArrayItem(idx),updateTabs(),void $nodeid.find("> a._jsonform-array-addmore").toggleClass("disabled",boundaries.maxItems>=0&&node.children.length>=boundaries.maxItems))},addItem=function(idx){if(boundaries.maxItems>=0){var slotNum=boundaries.maxItems-node.children.length;if($nodeid.find("> a._jsonform-array-addmore").toggleClass("disabled",slotNum<=1),slotNum<1)return!1}node.insertArrayItem(idx,$nodeid.find("> .tabbable > .tab-content").get(0)),updateTabs(idx),$nodeid.find("> a._jsonform-array-deleteitem").toggleClass("disabled",node.children.length<=boundaries.minItems)};if($("> a._jsonform-array-deleteitem",$nodeid).click(function(evt){var idx=$("> .tabbable > .nav-tabs .active",$nodeid).data("idx");evt.preventDefault(),evt.stopPropagation(),deleteItem(idx)}),$nodeid.on("click","> a._jsonform-array-addmore, > .tabbable > .nav-tabs > li > ._jsonform-array-addmore",function(evt){var idx=node.children.length;evt.preventDefault(),evt.stopPropagation(),addItem(idx)}),$nodeid.on("click","> .tabbable > .nav-tabs > li > a > ._jsonform-array-item-delete",function(e){e.preventDefault(),e.stopPropagation();var idx=$(e.currentTarget).closest("li").data("idx");deleteItem(idx)}),$(node.el).on("legendUpdated",function(evt){updateTabs(),evt.preventDefault(),evt.stopPropagation()}),!node.isReadOnly()&&$(node.el).sortable&&$("> .tabbable > .nav-tabs",$nodeid).sortable({containment:node.el,cancel:"._jsonform-array-addmore",tolerance:"pointer"}).on("sortchange",function(event,ui){ui.placeholder.index()==$(this).children().length-1&&ui.placeholder.prev().data("idx")==-1&&ui.placeholder.prev().before(ui.placeholder)}).on("sortstop",function(event,ui){var idx=$(ui.item).data("idx"),newIdx=$(ui.item).index();moveNodeTo(idx,newIdx),updateTabs(newIdx)}),boundaries.minItems>=0){for(var i=node.children.length;i<boundaries.minItems;i++)addItem(node.children.length);updateTabs(0)}else updateTabs();$nodeid.find("> a._jsonform-array-addmore").toggleClass("disabled",boundaries.maxItems>=0&&node.children.length>=boundaries.maxItems);var canDelete=boundaries.minItems>=0&&node.children.length<=boundaries.minItems;$nodeid.find("> a._jsonform-array-deleteitem").toggleClass("disabled",canDelete),$nodeid.find("> .tabbable > .nav-tabs > li > a > ._jsonform-array-item-delete").toggle(!canDelete)}},help:{template:'<span <%= id ? \'id="\' + id + \'"\' : "" %> class="help-block" style="padding-top:5px"><%= node.helpvalue || elt.helpvalue %></span>',fieldtemplate:!0},msg:{template:"<%= elt.msg %>"},html:{template:"<%= elt.html %>"},textview:{template:'<pre id="<%= id %>" name="<%= node.name %>"><%= value %></pre>',inputfield:!0,fieldtemplate:!0},fieldset:{template:'<fieldset class="jsonform-node jsonform-error-<%= keydash %> <% if (elt.expandable) { %>expandable<% } %> <%= elt.htmlClass?elt.htmlClass:"" %>" <% if (id) { %> id="<%= id %>"<% } %> data-jsonform-type="fieldset"><% if (node.title || node.legend) { %><legend><%= node.title || node.legend %></legend><% } %><% if (elt.expandable) { %><div hidden class="<%= cls.groupClass %>"><% } %><%= children %><% if (elt.expandable) { %></div><% } %><span class="help-block jsonform-errortext" style="display:none;"></span></fieldset>'},advancedfieldset:{template:'<fieldset<% if (id) { %> id="<%= id %>"<% } %> class="expandable jsonform-node jsonform-error-<%= keydash %> <%= elt.htmlClass?elt.htmlClass:"" %>" data-jsonform-type="advancedfieldset"><legend>Advanced options</legend><div hidden class="<%= cls.groupClass %>"><%= children %></div><span class="help-block jsonform-errortext" style="display:none;"></span></fieldset>'},authfieldset:{template:'<fieldset<% if (id) { %> id="<%= id %>"<% } %> class="expandable jsonform-node jsonform-error-<%= keydash %> <%= elt.htmlClass?elt.htmlClass:"" %>" data-jsonform-type="authfieldset"><legend>Authentication settings</legend><div hidden class="<%= cls.groupClass %>"><%= children %></div><span class="help-block jsonform-errortext" style="display:none;"></span></fieldset>'},submit:{template:'<input type="submit" <% if (id) { %> id="<%= id %>" <% } %> class="btn btn-primary <%= elt.htmlClass?elt.htmlClass:"" %>" value="<%= value || node.title %>"<%= (node.disabled? " disabled" : "")%>/>'},button:{template:' <button <% if (id) { %> id="<%= id %>" <% } %> class="<%= cls.buttonClass %> <%= elt.htmlClass?elt.htmlClass:"" %>"><%= node.title %></button> '},actions:{template:'<div class="form-actions <%= elt.htmlClass?elt.htmlClass:"" %>"><%= children %></div>'},hidden:{template:'<input type="hidden" id="<%= id %>" name="<%= node.name %>" value="<%= escape(value) %>" <%= (node.disabled? " disabled" : "")%> />',inputfield:!0},selectfieldset:{template:'<fieldset class="tab-container <%= elt.htmlClass?elt.htmlClass:"" %>"><% if (node.legend) { %><legend><%= node.legend %></legend><% } %><% if (node.formElement.key) { %><input type="hidden" id="<%= node.id %>" name="<%= node.name %>" value="<%= escape(value) %>" /><% } else { %><a id="<%= node.id %>"></a><% } %><div class="tabbable"><div class="<%= cls.groupClass %><%= node.formElement.hideMenu ? " hide" : "" %>"><% if (node.title && !elt.notitle) { %><label class="<%= cls.labelClass %>" for="<%= node.id %>"><%= node.title %></label><% } %><div class="<%= cls.controlClass %>"><%= tabs %></div></div><div class="tab-content"><%= children %></div></div></fieldset>',inputfield:!0,getElement:function(el){return $(el).parent().get(0)},childTemplate:function(inner){return'<div data-idx="<%= node.childPos %>" class="tab-pane<% if (node.active) { %> active<% } %>">'+inner+"</div>"},onBeforeRender:function(data,node){var children=null,choices=[];node.schemaElement&&(choices=node.schemaElement["enum"]||[]),children=node.options?_.map(node.options,function(option,idx){var child=node.children[idx];return option instanceof Object?(option=_.extend({node:child},option),option.title=option.title||child.legend||child.title||"Option "+(child.childPos+1),option.value=isSet(option.value)?option.value:isSet(choices[idx])?choices[idx]:idx,option):{title:option,value:isSet(choices[child.childPos])?choices[child.childPos]:child.childPos,node:child}}):_.map(node.children,function(child,idx){return{title:child.legend||child.title||"Option "+(child.childPos+1),value:choices[child.childPos]||child.childPos,node:child}});var activeChild=null;data.value&&(activeChild=_.find(children,function(child){return child.value===node.value})),activeChild||(activeChild=_.find(children,function(child){return child.node.hasNonDefaultValue()})),activeChild||(activeChild=children[0]),activeChild.node.active=!0,data.value=activeChild.value;var tabs=(node.formElement,'<select class="nav '+data.cls.textualInputClass+'"'+(node.disabled?" disabled":"")+">");return _.each(children,function(child,idx){tabs+='<option data-idx="'+idx+'" value="'+child.value+'"'+(child.node.active?' class="active"':"")+">"+escapeHTML(child.title)+"</option>"}),tabs+="</select>",data.tabs=tabs,data},onInsert:function(evt,node){$(node.el).find("select.nav").first().on("change",function(evt){var $option=$(this).find("option:selected");$(node.el).find('input[type="hidden"]').first().val($option.attr("value"))})}},optionfieldset:{template:'<div<% if (node.id) { %> id="<%= node.id %>"<% } %>><%= children %></div>'},section:{template:'<div<% if (node.id) { %> id="<%= node.id %>"<% } %> class="jsonform-node jsonform-error-<%= keydash %> <%= elt.htmlClass?elt.htmlClass:"" %>"><%= children %></div>'},questions:{template:'<div><input type="hidden" id="<%= node.id %>" name="<%= node.name %>" value="<%= escape(value) %>" /><%= children %></div>',fieldtemplate:!0,inputfield:!0,getElement:function(el){return $(el).parent().get(0)},onInsert:function(evt,node){node.children&&0!==node.children.length&&(_.each(node.children,function(child){$(child.el).hide()}),$(node.children[0].el).show())}},question:{template:'<div id="<%= node.id %>"><% _.each(node.options, function(key, val) { %><% if (elt.optionsType === "radiobuttons") { %><label class="<%= cls.buttonClass%> <%= ((key instanceof Object && key.htmlClass) ? " " + key.htmlClass : "") %>"><% } else { %><% if (!elt.inline) { %><div class="radio"><% } %><label class="<%= elt.inline ? "radio"+cls.inlineClassSuffix : "" %> <%= ((key instanceof Object && key.htmlClass) ? " " + key.htmlClass : "") %>"><% } %><input type="radio" <% if (elt.optionsType === "radiobuttons") { %> style="position:absolute;left:-9999px;" <% } %>name="<%= node.id %>" value="<%= val %>"<%= (node.disabled? " disabled" : "")%>/><span><%= (key instanceof Object ? key.title : key) %></span></label><%= elt.optionsType !== "radiobuttons" && !elt.inline ? "</div>" : "" %> <% }); %></div>',fieldtemplate:!0,onInsert:function(evt,node){var activeClass="active",elt=node.formElement||{};elt.activeClass&&(activeClass+=" "+elt.activeClass),$(node.el).find('input[type="radio"]').on("change",function(evt){var questionNode=null,option=node.options[$(this).val()];node.parentNode&&node.parentNode.el&&($(node.el).find("label").removeClass(activeClass),$(this).parent().addClass(activeClass),$(node.el).nextAll().hide(),$(node.el).nextAll().find('input[type="radio"]').prop("checked",!1),option.value&&$(node.parentNode.el).find('input[type="hidden"]').val(option.value),option.next&&(questionNode=_.find(node.parentNode.children,function(child){return child.formElement&&child.formElement.qid===option.next}),$(questionNode.el).show(),$(questionNode.el).nextAll().hide(),$(questionNode.el).nextAll().find('input[type="radio"]').prop("checked",!1)),option.href&&(option.target?window.open(option.href,option.target):window.location=option.href),option.submit&&setTimeout(function(){node.ownerTree.submit()},0))})}}},jsonform.util.getObjKey=function(obj,key,ignoreArrays){for(var innerobj=obj,keyparts=key.split("."),subkey=null,arrayMatch=null,prop=null,i=0;i<keyparts.length;i++){if(null===innerobj||"object"!=typeof innerobj)return null;if(subkey=keyparts[i],prop=subkey.replace(reArray,""),reArray.lastIndex=0,arrayMatch=reArray.exec(subkey))for(innerobj=innerobj[prop];;){if(!_.isArray(innerobj))return null;if(innerobj=innerobj[parseInt(arrayMatch[1],10)],arrayMatch=reArray.exec(subkey),!arrayMatch)break}else innerobj=ignoreArrays&&!innerobj[prop]&&_.isArray(innerobj)&&innerobj[0]?innerobj[0][prop]:innerobj[prop]}return ignoreArrays&&_.isArray(innerobj)&&innerobj[0]?innerobj[0]:innerobj},jsonform.util.getObjKeyEx=function(obj,key,objKey){var innerobj=obj;if(null===key||void 0===key||""===key)return obj;if("string"==typeof objKey&&objKey.length>0){if(key.slice(0,objKey.length)!==objKey)throw console.log([objKey,obj,key]),new Error("key ["+key+"] does not match the objKey ["+objKey+"]");key=key.slice(objKey.length),"."===key[0]&&(key=key.slice(1))}var m=key.match(/^((([^\\\[.]|\\.)+)|\[(\d+)\])\.?(.*)$/);if(!m)throw new Error("bad format key: "+key);if("string"==typeof m[2]&&m[2].length>0)innerobj=innerobj[m[2]];else{if(!("string"==typeof m[4]&&m[4].length>0))throw new Error("impossible reach here");innerobj=innerobj[Number(m[4])]}return innerobj&&m[5].length>0&&(innerobj=this.getObjKeyEx(innerobj,m[5])),innerobj},jsonform.util.setObjKey=function(obj,key,value){for(var innerobj=obj,keyparts=key.split("."),subkey=null,arrayMatch=null,prop=null,i=0;i<keyparts.length-1;i++)if(subkey=keyparts[i],prop=subkey.replace(reArray,""),reArray.lastIndex=0,arrayMatch=reArray.exec(subkey)){for(;;)if(_.isArray(innerobj[prop])||(innerobj[prop]=[]),innerobj=innerobj[prop],prop=parseInt(arrayMatch[1],10),arrayMatch=reArray.exec(subkey),!arrayMatch)break;"object"==typeof innerobj[prop]&&null!==innerobj[prop]||(innerobj[prop]={}),innerobj=innerobj[prop]}else"object"==typeof innerobj[prop]&&null!==innerobj[prop]||(innerobj[prop]={}),innerobj=innerobj[prop];if(subkey=keyparts[keyparts.length-1],prop=subkey.replace(reArray,""),reArray.lastIndex=0,arrayMatch=reArray.exec(subkey)){for(;;)if(_.isArray(innerobj[prop])||(innerobj[prop]=[]),innerobj=innerobj[prop],prop=parseInt(arrayMatch[1],10),arrayMatch=reArray.exec(subkey),!arrayMatch)break;innerobj[prop]=value}else innerobj[prop]=value};var getSchemaKey=function(schema,key){var schemaKey=key.replace(/\./g,".properties.").replace(/\[[0-9]*\]/g,".items"),schemaDef=jsonform.util.getObjKey(schema,schemaKey,!0);if(schemaDef&&schemaDef.$ref)throw new Error("JSONForm does not yet support schemas that use the $ref keyword. See: https://github.com/joshfire/jsonform/issues/54");return schemaDef},getSchemaDefaultByKeyWithArrayIdx=function(schema,key,topDefaultArrayLevel){topDefaultArrayLevel=topDefaultArrayLevel||0;var defaultValue=void 0;if(isSet(key)&&""!==key)if(schema["default"]&&0==topDefaultArrayLevel)defaultValue=jsonform.util.getObjKeyEx(schema["default"],key);else{var m=key.match(/^((([^\\\[.]|\\.)+)|\[(\d+)\])\.?(.*)$/);if(!m)throw new Error("bad format key: "+key);if("string"==typeof m[2]&&m[2].length>0)schema=schema.properties[m[2]];else{if(!("string"==typeof m[4]&&m[4].length>0))throw new Error("impossible reach here");schema=schema.items,topDefaultArrayLevel>0&&--topDefaultArrayLevel}schema&&(defaultValue=schema["default"]&&0==topDefaultArrayLevel?jsonform.util.getObjKeyEx(schema["default"],m[5]):getSchemaDefaultByKeyWithArrayIdx(schema,m[5],topDefaultArrayLevel))}else 0==topDefaultArrayLevel&&(defaultValue=schema["default"]);return defaultValue},applyArrayPath=function(key,arrayPath,emptyIdxOnly){var depth=0;if(!key)return null;if(!arrayPath||0===arrayPath.length)return key;var newKey=key.replace(reArray,function(str,p1){var newIndex=str;return emptyIdxOnly&&2!=newIndex.length||!isSet(arrayPath[depth])||(newIndex="["+arrayPath[depth]+"]"),depth+=1,newIndex});return newKey},getInitialValue=function(formObject,key,arrayPath,tpldata,usePreviousValues){var value=null;tpldata=tpldata||{},tpldata.idx=tpldata.idx||(arrayPath?arrayPath[arrayPath.length-1]:1),tpldata.value=isSet(tpldata.value)?tpldata.value:"",tpldata.getValue=tpldata.getValue||function(key){return getInitialValue(formObject,key,arrayPath,tpldata,usePreviousValues)};var getFormElement=function(elements,key){var formElement=null;return elements&&elements.length?(_.each(elements,function(elt){if(!formElement)return elt===key?void(formElement={key:elt}):void(_.isString(elt)||(elt.key===key?formElement=elt:elt.items&&(formElement=getFormElement(elt.items,key))))}),formElement):null},formElement=getFormElement(formObject.form||[],key),schemaElement=getSchemaKey(formObject.schema.properties,key);return usePreviousValues&&formObject.value&&(value=jsonform.util.getObjKey(formObject.value,applyArrayPath(key,arrayPath))),isSet(value)||(formElement&&"undefined"!=typeof formElement.value?value=formElement.value:schemaElement&&isSet(schemaElement["default"])&&(value=schemaElement["default"]),value&&value.indexOf("{{values.")!==-1&&(value=value.replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}')),value&&(value=_template(value,tpldata,valueTemplateSettings))),isSet(value)&&formElement&&hasOwnProperty(formElement.titleMap,value)&&(value=_template(formElement.titleMap[value],tpldata,valueTemplateSettings)),value&&_.isString(value)&&schemaElement&&schemaElement.maxLength&&value.length>schemaElement.maxLength&&(value=value.substr(0,schemaElement.maxLength-1)+""),isSet(value)?value:null},formNode=function(){this.id=null,this.key=null,this.el=null,this.formElement=null,this.schemaElement=null,this.view=null,this.children=[],this.ownerTree=null,this.parentNode=null,this.childTemplate=null,this.legendChild=null,this.arrayPath=[],this.childPos=0};formNode.prototype.clone=function(parentNode){var node=new formNode;return node.childPos=this.childPos,node.arrayPath=_.clone(this.arrayPath),node.ownerTree=this.ownerTree,node.parentNode=parentNode||this.parentNode,node.formElement=this.formElement,node.schemaElement=this.schemaElement,node.view=this.view,node.children=_.map(this.children,function(child){return child.clone(node)}),node},formNode.prototype.hasNonDefaultValue=function(){if(this.formElement&&"hidden"==this.formElement.type)return!1;if(this.value&&!this.defaultValue)return!0;var child=_.find(this.children,function(child){return child.hasNonDefaultValue()});return!!child},formNode.prototype.getProperty=function(prop,searchInParents){var value=this[prop];return void 0===value&&searchInParents&&this.parentNode?this.parentNode.getProperty(prop,!0):value},formNode.prototype.isReadOnly=function(){return this.getProperty("readOnly",!0)},formNode.prototype.appendChild=function(node){return node.parentNode=this,node.childPos=this.children.length,this.children.push(node),node},formNode.prototype.removeChild=function(){var child=this.children[this.children.length-1];if(child)return $(child.el).remove(),this.children.pop()},formNode.prototype.moveValuesTo=function(node){var values=this.getFormValues(node.arrayPath);node.resetValues(),node.computeInitialValues(values,!0)},formNode.prototype.switchValuesWith=function(node){var values=this.getFormValues(node.arrayPath),nodeValues=node.getFormValues(this.arrayPath);node.resetValues(),node.computeInitialValues(values,!0),this.resetValues(),this.computeInitialValues(nodeValues,!0)},formNode.prototype.resetValues=function(){var params=null;if(this.value=null,this.parentNode?(this.arrayPath=_.clone(this.parentNode.arrayPath),this.parentNode.view&&this.parentNode.view.array&&this.arrayPath.push(this.childPos)):this.arrayPath=[],this.view&&this.view.inputfield)params=$(":input",this.el).serializeArray(),_.each(params,function(param){$('[name="'+escapeSelector(param.name)+'"]',$(this.el)).val("")},this);else if(this.view&&this.view.array)for(;this.children.length>0;)this.removeChild();_.each(this.children,function(child){child.resetValues()})},formNode.prototype.setChildTemplate=function(node){this.childTemplate=node,node.parentNode=this},formNode.prototype.getChildTemplate=function(){return this.childTemplate||this.view.array&&(this.formElement.items?key=this.formElement.items[0]||this.formElement.items:key=this.formElement.key+"[]",_.isString(key)&&(key={key:key}),this.setChildTemplate(this.ownerTree.buildFromLayout(key))),this.childTemplate},formNode.prototype.computeInitialValues=function(values,ignoreDefaultValues,topDefaultArrayLevel){var self=this,node=null,nbChildren=1,i=0,formData=this.ownerTree.formDesc.tpldata||{};if(topDefaultArrayLevel=topDefaultArrayLevel||0,this.parentNode?(this.arrayPath=_.clone(this.parentNode.arrayPath),this.parentNode.view&&this.parentNode.view.array&&this.arrayPath.push(this.childPos)):this.arrayPath=[],formData.idx=this.arrayPath.length>0?this.arrayPath[this.arrayPath.length-1]+1:this.childPos+1,formData.value="",formData.getValue=function(key){return getInitialValue(self.ownerTree.formDesc,key,self.arrayPath,formData,!!values)},this.formElement&&(this.formElement.id?this.id=applyArrayPath(this.formElement.id,this.arrayPath):this.view&&this.view.array?this.id=escapeSelector(this.ownerTree.formDesc.prefix)+"-elt-counter-"+_.uniqueId():this.parentNode&&this.parentNode.view&&this.parentNode.view.array?this.id=escapeSelector(this.ownerTree.formDesc.prefix)+"-elt-counter-"+_.uniqueId():"button"!==this.formElement.type&&"selectfieldset"!==this.formElement.type&&"question"!==this.formElement.type&&"buttonquestion"!==this.formElement.type||(this.id=escapeSelector(this.ownerTree.formDesc.prefix)+"-elt-counter-"+_.uniqueId()),this.formElement.key&&(this.key=applyArrayPath(this.formElement.key,this.arrayPath),this.keydash=this.key.replace(/\./g,"---")),this.name=applyArrayPath(this.formElement.name,this.arrayPath),_.each(["title","legend","description","append","prepend","inlinetitle","helpvalue","value","disabled","required","placeholder","readOnly"],function(prop){_.isString(this.formElement[prop])?(this.formElement[prop].indexOf("{{values.")!==-1?this[prop]=this.formElement[prop].replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}'):this[prop]=applyArrayPath(this.formElement[prop],this.arrayPath),this[prop]&&(this[prop]=_template(this[prop],formData,valueTemplateSettings))):this[prop]=this.formElement[prop]},this),this.formElement.options&&(this.options=_.map(this.formElement.options,function(option){var title=null;return _.isObject(option)&&option.title?(title=option.title.indexOf("{{values.")!==-1?option.title.replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}'):applyArrayPath(option.title,self.arrayPath),_.extend({},option,{value:isSet(option.value)?option.value:"",title:_template(title,formData,valueTemplateSettings)})):option}))),this.view&&this.view.inputfield&&this.schemaElement){if(values)isSet(jsonform.util.getObjKey(values,this.key))&&(this.value=jsonform.util.getObjKey(values,this.key));else if(!ignoreDefaultValues&&!isSet(this.value)){var schemaDefault=getSchemaDefaultByKeyWithArrayIdx(self.ownerTree.formDesc.schema,this.key,topDefaultArrayLevel);isSet(schemaDefault)&&(this.value=schemaDefault,_.isString(this.value)&&(this.value.indexOf("{{values.")!==-1?this.value=this.value.replace(/\{\{values\.([^\}]+)\}\}/g,'{{getValue("$1")}}'):this.value=applyArrayPath(this.value,this.arrayPath,!0),this.value&&(this.value=_template(this.value,formData,valueTemplateSettings))),this.defaultValue=!0)}}else if(this.view&&this.view.array){nbChildren=1;var minItems=this.getArrayBoundaries().minItems;if(values){var previousArrayValue=jsonform.util.getObjKeyEx(values,this.key);previousArrayValue&&Array.isArray(previousArrayValue)&&(nbChildren=previousArrayValue.length)}else if(ignoreDefaultValues)minItems>=0&&(nbChildren=0);else{var schemaDefault=getSchemaDefaultByKeyWithArrayIdx(self.ownerTree.formDesc.schema,this.key,topDefaultArrayLevel);schemaDefault&&Array.isArray(schemaDefault)&&(nbChildren=schemaDefault.length)}for(i=0;i<nbChildren;i++)this.appendChild(this.getChildTemplate().clone())}if(_.each(this.children,function(child){child.computeInitialValues(values,ignoreDefaultValues,topDefaultArrayLevel)}),this.formElement&&this.formElement.valueInLegend)for(node=this;node;){if(node.parentNode&&node.parentNode.view&&node.parentNode.view.array&&(node.legendChild=this,node.formElement&&node.formElement.legend)){node.legend=applyArrayPath(node.formElement.legend,node.arrayPath),formData.idx=node.arrayPath.length>0?node.arrayPath[node.arrayPath.length-1]+1:node.childPos+1,formData.value=isSet(this.value)?this.value:"",node.legend=_template(node.legend,formData,valueTemplateSettings);break}node=node.parentNode}},formNode.prototype.getFormValues=function(updateArrayPath){var values={};if(!this.el)throw new Error("formNode.getFormValues can only be called on nodes that are associated with a DOM element in the tree");var formArray=$(":input",this.el).serializeArray();formArray=formArray.concat($(":input[type=checkbox]:not(:disabled):not(:checked)[name]",this.el).map(function(){return{name:this.name,value:this.checked}}).get()),updateArrayPath&&_.each(formArray,function(param){param.name=applyArrayPath(param.name,updateArrayPath)});for(var formSchema=this.ownerTree.formDesc.schema,i=0;i<formArray.length;i++){var name=formArray[i].name,eltSchema=getSchemaKey(formSchema.properties,name),arrayMatch=null,cval=null;if(eltSchema)if(eltSchema._jsonform_checkboxes_as_array&&(arrayMatch=name.match(/\[([0-9]*)\]$/)))name=name.replace(/\[([0-9]*)\]$/,""),cval=jsonform.util.getObjKey(values,name)||[],"value"===eltSchema._jsonform_checkboxes_as_array&&formArray[i].value!==!1&&""!==formArray[i].value?cval.push(formArray[i].value):eltSchema._jsonform_checkboxes_as_array===!0&&"1"===formArray[i].value&&cval.push(eltSchema["enum"][parseInt(arrayMatch[1],10)]),jsonform.util.setObjKey(values,name,cval);else if("tagsinput"!==eltSchema._jsonform_get_value_by_tagsinput)if("[]"!==name.slice(-2)||(name=name.slice(0,-2),eltSchema=getSchemaKey(formSchema.properties,name),"array"!==eltSchema.type)){if("boolean"===eltSchema.type&&("0"===formArray[i].value||"false"===formArray[i].value?formArray[i].value=!1:""===formArray[i].value?formArray[i].value=null:formArray[i].value=!!formArray[i].value),"number"!==eltSchema.type&&"integer"!==eltSchema.type||_.isString(formArray[i].value)&&(formArray[i].value.length?isNaN(Number(formArray[i].value))||(formArray[i].value=Number(formArray[i].value)):formArray[i].value=null),"string"!==eltSchema.type||""!==formArray[i].value||eltSchema._jsonform_allowEmpty||(formArray[i].value=null),"object"===eltSchema.type&&_.isString(formArray[i].value)&&"{"===formArray[i].value.substring(0,1))try{formArray[i].value=JSON.parse(formArray[i].value)}catch(e){formArray[i].value={}}if("array"===eltSchema.type&&_.isString(formArray[i].value))if("["===formArray[i].value.substring(0,1))try{formArray[i].value=JSON.parse(formArray[i].value)}catch(e){formArray[i].value=[]}else formArray[i].value=null;"object"!==eltSchema.type||"null"!==formArray[i].value&&""!==formArray[i].value||(formArray[i].value=null),formArray[i].name&&null!==formArray[i].value&&jsonform.util.setObjKey(values,formArray[i].name,formArray[i].value)}else cval=jsonform.util.getObjKey(values,name)||[],cval.indexOf(formArray[i].value)<0&&(cval.push(formArray[i].value),jsonform.util.setObjKey(values,name,cval));else{var vals;if(updateArrayPath){var oriName=applyArrayPath(name,this.arrayPath);vals=$(':input[name="'+oriName+'"]',this.el).tagsinput("items")}else vals=$(':input[name="'+name+'"]',this.el).tagsinput("items");
jsonform.util.setObjKey(values,name,vals)}}return values},formNode.prototype.render=function(el){var html=this.generate();this.setContent(html,el),this.enhance()},formNode.prototype.setContent=function(html,parentEl){var node=$(html),parentNode=parentEl||(this.parentNode?this.parentNode.el:this.ownerTree.domRoot),nextSibling=null;this.el?$(this.el).replaceWith(node):(nextSibling=$(parentNode).children().get(this.childPos),nextSibling?$(nextSibling).before(node):$(parentNode).append(node)),this.el=node,this.updateElement(this.el)},formNode.prototype.updateElement=function(domNode){this.id&&(this.el=$("#"+escapeSelector(this.id),domNode).get(0),this.view&&this.view.getElement&&(this.el=this.view.getElement(this.el)),this.fieldtemplate!==!1&&this.view&&this.view.fieldtemplate&&(this.el=$(this.el).parent().parent(),(this.prepend||this.append)&&(this.el=this.el.parent()),this.el=this.el.get(0)),this.parentNode&&this.parentNode.view&&this.parentNode.view.childTemplate&&(this.el=$(this.el).parent().get(0))),_.each(this.children,function(child){child.updateElement(this.el||domNode)})},formNode.prototype.generate=function(){var data={id:this.id,keydash:this.keydash,elt:this.formElement,schema:this.schemaElement,node:this,value:isSet(this.value)?this.value:"",cls:this.ownerTree.defaultClasses,escape:escapeHTML},template=null,html="";this.ownerTree.formDesc.onBeforeRender&&this.ownerTree.formDesc.onBeforeRender(data,this),this.view.onBeforeRender&&this.view.onBeforeRender(data,this),template=this.template?this.template:this.formElement&&this.formElement.template?this.formElement.template:this.view.template,this.fieldtemplate!==!1&&(this.fieldtemplate||this.view.fieldtemplate)&&(template=jsonform.fieldTemplate(template)),this.parentNode&&this.parentNode.view&&this.parentNode.view.childTemplate&&(template=this.parentNode.view.childTemplate(template,this.parentNode));var childrenhtml="";return _.each(this.children,function(child){childrenhtml+=child.generate()}),data.children=childrenhtml,data.fieldHtmlClass="",this.ownerTree&&this.ownerTree.formDesc&&this.ownerTree.formDesc.params&&this.ownerTree.formDesc.params.fieldHtmlClass&&(data.fieldHtmlClass=this.ownerTree.formDesc.params.fieldHtmlClass),this.formElement&&"undefined"!=typeof this.formElement.fieldHtmlClass&&(data.fieldHtmlClass=this.formElement.fieldHtmlClass),html=_template(template,data,fieldTemplateSettings)},formNode.prototype.enhance=function(){function onLegendChildChange(evt){node.formElement&&node.formElement.legend&&node.parentNode&&(node.legend=applyArrayPath(node.formElement.legend,node.arrayPath),formData.idx=node.arrayPath.length>0?node.arrayPath[node.arrayPath.length-1]+1:node.childPos+1,formData.value=$(evt.target).val(),node.legend=_template(node.legend,formData,valueTemplateSettings),$(node.parentNode.el).trigger("legendUpdated"))}var node=this,handlers=null,handler=null,formData=_.clone(this.ownerTree.formDesc.tpldata)||{};this.formElement&&(this.view.onInsert&&this.view.onInsert({target:$(this.el)},this),handlers=this.handlers||this.formElement.handlers,handler=this.onInsert||this.formElement.onInsert,handler&&handler({target:$(this.el)},this),handlers&&_.each(handlers,function(handler,onevent){"insert"===onevent&&handler({target:$(this.el)},this)},this),this.el&&(this.onChange&&$(this.el).bind("change",function(evt){node.onChange(evt,node)}),this.view.onChange&&$(this.el).bind("change",function(evt){node.view.onChange(evt,node)}),this.formElement.onChange&&$(this.el).bind("change",function(evt){node.formElement.onChange(evt,node)}),this.onClick&&$(this.el).bind("click",function(evt){node.onClick(evt,node)}),this.view.onClick&&$(this.el).bind("click",function(evt){node.view.onClick(evt,node)}),this.formElement.onClick&&$(this.el).bind("click",function(evt){node.formElement.onClick(evt,node)}),this.onKeyUp&&$(this.el).bind("keyup",function(evt){node.onKeyUp(evt,node)}),this.view.onKeyUp&&$(this.el).bind("keyup",function(evt){node.view.onKeyUp(evt,node)}),this.formElement.onKeyUp&&$(this.el).bind("keyup",function(evt){node.formElement.onKeyUp(evt,node)}),handlers&&_.each(handlers,function(handler,onevent){"insert"!==onevent&&$(this.el).bind(onevent,function(evt){handler(evt,node)})},this)),this.formElement.legend&&this.legendChild&&this.legendChild.formElement&&($(this.legendChild.el).on("keyup",onLegendChildChange),$(this.legendChild.el).on("change",onLegendChildChange))),_.each(this.children,function(child){child.enhance()})},formNode.prototype.insertArrayItem=function(idx,domElement){var i=0;void 0===idx&&(idx=this.children.length);var child=this.getChildTemplate().clone();for(this.appendChild(child),child.resetValues(),i=this.children.length-2;i>=idx;i--)this.children[i].moveValuesTo(this.children[i+1]);for(this.children[idx].resetValues(),this.children[idx].computeInitialValues(null,!1,this.children[idx].arrayPath.length),i=idx;i<this.children.length;i++)this.children[i].render(domElement)},formNode.prototype.deleteArrayItem=function(idx){var i=0;for(void 0===idx&&(idx=this.children.length-1),i=idx;i<this.children.length-1;i++)this.children[i+1].moveValuesTo(this.children[i]),this.children[i].render();this.removeChild()},formNode.prototype.getArrayBoundaries=function(){var boundaries={minItems:-1,maxItems:-1};if(!this.view||!this.view.array)return boundaries;var getNodeBoundaries=function(node,initialNode){var schemaKey=null,arrayKey=null,boundaries={minItems:-1,maxItems:-1};return initialNode=initialNode||node,node.view&&node.view.array&&node!==initialNode?boundaries:node.key?(arrayKey=node.key.replace(/\[[0-9]+\]/g,"[]"),node!==initialNode&&(arrayKey=arrayKey.replace(/\[\][^\[\]]*$/,"")),(schemaKey=getSchemaKey(node.ownerTree.formDesc.schema.properties,arrayKey))?(schemaKey.minItems>=0&&(boundaries.minItems=schemaKey.minItems),schemaKey.minLength>=0&&(boundaries.minItems=schemaKey.minLength),schemaKey.maxItems>=0&&(boundaries.maxItems=schemaKey.maxItems),schemaKey.maxLength>=0&&(boundaries.maxItems=schemaKey.maxLength),boundaries):boundaries):(_.each(node.children,function(child){var subBoundaries=getNodeBoundaries(child,initialNode);subBoundaries.minItems!==-1&&(boundaries.minItems!==-1?boundaries.minItems=Math.max(boundaries.minItems,subBoundaries.minItems):boundaries.minItems=subBoundaries.minItems),subBoundaries.maxItems!==-1&&(boundaries.maxItems!==-1?boundaries.maxItems=Math.min(boundaries.maxItems,subBoundaries.maxItems):boundaries.maxItems=subBoundaries.maxItems)}),boundaries)};return getNodeBoundaries(this)};var formTree=function(){this.eventhandlers=[],this.root=null,this.formDesc=null};formTree.prototype.initialize=function(formDesc){function convertSchemaV3ToV4(schema){if(schema&&schema.properties){var required=Array.isArray(schema.required)?schema.required:[];for(var field in schema.properties){var fieldSchema=schema.properties[field];if(fieldSchema.required===!0)required.indexOf(field)<0&&required.push(field);else if(void 0!==fieldSchema.required&&fieldSchema.required!==!1&&!Array.isArray(fieldSchema.required))throw new Error("field "+field+"'s required property should be either boolean or array of strings");if("object"===fieldSchema.type?processedSchemaNodes.indexOf(fieldSchema)<0&&(processedSchemaNodes.push(fieldSchema),convertSchemaV3ToV4(fieldSchema)):delete fieldSchema.required,"array"===fieldSchema.type&&fieldSchema.items){if(Array.isArray(fieldSchema.items))throw new Error("the items property of array property "+field+" in the schema definition must be an object");"object"===fieldSchema.items.type&&processedSchemaNodes.indexOf(fieldSchema.items)<0&&(processedSchemaNodes.push(fieldSchema.items),convertSchemaV3ToV4(fieldSchema.items))}}required.length>0?schema.required=required:delete schema.required}}function resolveRefs(obj,defs){Object.keys(obj).forEach(function(prop,index,array){var def=obj[prop];if(null!==def&&"object"==typeof def)if(def.$ref)if("#/definitions/"===def.$ref.slice(0,14)){var ref=def.$ref.replace(/^#\/definitions\//,"");obj[prop]=defs[ref]}else console.log("Unresolved $ref: "+def.$ref);else resolvedSchemaRefNodes.indexOf(def)<0&&(resolveRefs(def,defs),resolvedSchemaRefNodes.push(def))})}formDesc=formDesc||{},this.formDesc=_.clone(formDesc),jsonform.defaultClasses=getDefaultClasses(this.formDesc.isBootstrap2||jsonform.isBootstrap2),this.defaultClasses=_.clone(jsonform.defaultClasses),this.formDesc.defaultClasses&&_.extend(this.defaultClasses,this.formDesc.defaultClasses),this.formDesc.prefix=this.formDesc.prefix||"jsonform-"+_.uniqueId(),this.formDesc.schema&&!this.formDesc.schema.properties&&(this.formDesc.schema={properties:this.formDesc.schema});var processedSchemaNodes=[];if(convertSchemaV3ToV4(this.formDesc.schema),this.formDesc.schema.definitions)for(var definition in this.formDesc.schema.definitions)convertSchemaV3ToV4(this.formDesc.schema.definitions[definition]);this.formDesc._originalSchema=this.formDesc.schema,this.formDesc.schema=JSON.parse(JSON.stringify(this.formDesc.schema));var resolvedSchemaRefNodes=[];this.formDesc.schema.definitions&&resolveRefs(this.formDesc.schema,this.formDesc.schema.definitions),this.formDesc.form=this.formDesc.form||["*",{type:"actions",items:[{type:"submit",value:"Submit"}]}],this.formDesc.form=_.isArray(this.formDesc.form)?this.formDesc.form:[this.formDesc.form],this.formDesc.params=this.formDesc.params||{},this.root=new formNode,this.root.ownerTree=this,this.root.view=jsonform.elementTypes.root,this.buildTree(),this.computeInitialValues()},formTree.prototype.buildTree=function(){_.each(this.formDesc.form,function(formElement){"*"===formElement?_.each(this.formDesc.schema.properties,function(element,key){this.formDesc.nonDefaultFormItems&&this.formDesc.nonDefaultFormItems.indexOf(key)>=0||this.root.appendChild(this.buildFromLayout({key:key}))},this):(_.isString(formElement)&&(formElement={key:formElement}),this.root.appendChild(this.buildFromLayout(formElement)))},this)},formTree.prototype.buildFromLayout=function(formElement,context){function isRequiredField(key,schema){var parts=key.split("."),field=parts.pop();if("[]"==field.slice(-2))return!1;var parentKey=parts.join("."),required=!1;if(parentKey){var parentSchema=getSchemaKey(schema.properties,parentKey);required=parentSchema.required&&parentSchema.required.indexOf(field)>=0,required&&(required="[]"==parentKey.slice(-2)||isRequiredField(parentKey,schema))}else required=schema.required&&schema.required.indexOf(field)>=0;return required}function prepareOptions(formElement,enumValues){formElement.options?Array.isArray(formElement.options)?formElement.options=formElement.options.map(function(value){return hasOwnProperty(value,"value")?value:{value:value,title:value}}):"object"==typeof formElement.options&&(formElement.options=Object.keys(formElement.options).map(function(value){return{value:value,title:formElement.options[value]}})):formElement.titleMap?formElement.options=_.map(enumValues,function(value){var title=value.toString();return{value:value,title:hasOwnProperty(formElement.titleMap,title)?formElement.titleMap[title]:title}}):formElement.options=enumValues.map(function(value){return{value:value,title:value.toString()}})}var schemaElement=null,node=new formNode,view=null;if(formElement.key&&this.formDesc.customFormItems){var formEl=this.formDesc.customFormItems[formElement.key];void 0!==formEl&&(formEl.key=formElement.key,formElement=formEl)}if(formElement=_.clone(formElement),formElement.items&&(_.isArray(formElement.items)?formElement.items=_.map(formElement.items,_.clone):formElement.items=[_.clone(formElement.items)]),formElement.key){if(schemaElement=getSchemaKey(this.formDesc.schema.properties,formElement.key),!schemaElement)throw new Error('The JSONForm object references the schema key "'+formElement.key+'" but that key does not exist in the JSON schema');if(this.formDesc.onElementSchema&&this.formDesc.onElementSchema(formElement,schemaElement),formElement.name=formElement.name||formElement.key,formElement.title=formElement.title||schemaElement.title,formElement.description=formElement.description||schemaElement.description,formElement.readOnly=formElement.readOnly||schemaElement.readOnly||formElement.readonly||schemaElement.readonly,formElement.required=formElement.required===!0||schemaElement.required===!0||isRequiredField(formElement.key,this.formDesc.schema),formElement.id||(formElement.id=escapeSelector(this.formDesc.prefix)+"-elt-"+formElement.key),formElement.allowEmpty&&(schemaElement._jsonform_allowEmpty=!0),formElement.type||("string"===schemaElement.type&&"color"===schemaElement.format?formElement.type="color":"number"!==schemaElement.type&&"integer"!==schemaElement.type||schemaElement["enum"]?"string"!==schemaElement.type&&"any"!==schemaElement.type||schemaElement["enum"]?"boolean"===schemaElement.type?formElement.type="checkbox":"object"===schemaElement.type?schemaElement.properties?formElement.type="fieldset":formElement.type="textarea":_.isUndefined(schemaElement["enum"])?formElement.type=schemaElement.type:formElement.type="select":formElement.type="text":formElement.type="number"),formElement.options)prepareOptions(formElement);else if(schemaElement["enum"]||"boolean"===schemaElement.type){var enumValues=schemaElement["enum"];enumValues?formElement.optionsAsEnumOrder=!0:enumValues="select"===formElement.type?["",!0,!1]:[!0,!1],prepareOptions(formElement,enumValues)}if(("checkboxes"===formElement.type||"checkboxbuttons"===formElement.type)&&schemaElement.items){var theItem=Array.isArray(schemaElement.items)?schemaElement.items[0]:schemaElement.items;if(formElement.options)prepareOptions(formElement),theItem._jsonform_checkboxes_as_array="value";else{var enumValues=theItem["enum"];enumValues&&(prepareOptions(formElement,enumValues),formElement.optionsAsEnumOrder=!0,theItem._jsonform_checkboxes_as_array="checkboxes"===formElement.type||"value")}}"tagsinput"===formElement.getValue&&(schemaElement._jsonform_get_value_by_tagsinput="tagsinput"),"object"===schemaElement.type&&_.each(schemaElement.properties,function(prop,propName){var key=formElement.key+"."+propName;this.formDesc.nonDefaultFormItems&&this.formDesc.nonDefaultFormItems.indexOf(key)>=0||node.appendChild(this.buildFromLayout({key:key}))},this)}if(formElement.type||(formElement.type="text"),view=jsonform.elementTypes[formElement.type],!view)throw new Error('The JSONForm contains an element whose type is unknown: "'+formElement.type+'"');if(schemaElement){if(!view.inputfield&&!view.array&&"selectfieldset"!==formElement.type&&"object"!==schemaElement.type)throw new Error('The JSONForm contains an element that links to an element in the JSON schema (key: "'+formElement.key+'") and that should not based on its type ("'+formElement.type+'")')}else if(view.inputfield&&"selectfieldset"!==formElement.type)throw new Error('The JSONForm defines an element of type "'+formElement.type+'" but no "key" property to link the input field to the JSON schema');if(formElement.iddot=escapeSelector(formElement.id||""),node.formElement=formElement,node.schemaElement=schemaElement,node.view=view,node.ownerTree=this,formElement.handlers||(formElement.handlers={}),node.view.array);else if(formElement.items)_.each(formElement.items,function(item){_.isString(item)&&(item={key:item}),node.appendChild(this.buildFromLayout(item))},this);else if(formElement.otherField){var item=formElement.otherField;_.isString(item)?item=formElement.otherField={key:item,notitle:!0}:void 0===item.notitle&&(item.notitle=!0),void 0===item.inline&&(item.inline=formElement.inline),node.appendChild(this.buildFromLayout(item))}return node},formTree.prototype.computeInitialValues=function(){this.root.computeInitialValues(this.formDesc.value)},formTree.prototype.render=function(domRoot){domRoot&&(this.domRoot=domRoot,this.root.render(),this.hasRequiredField()&&$(domRoot).addClass("jsonform-hasrequired"),$(domRoot).addClass("jsonform"))},formTree.prototype.forEachElement=function(callback){var f=function(root){for(var i=0;i<root.children.length;i++)callback(root.children[i]),f(root.children[i])};f(this.root)},formTree.prototype.validate=function(noErrorDisplay){var values=jsonform.getFormValue(this.domRoot),errors=!1,options=this.formDesc;if(options.validate!==!1){var validator=!1;if("object"!=typeof options.validate?global.ZSchema?(validator=new global.ZSchema,validator._vendor="z-schema"):global.jjv?(validator=global.jjv(),validator._vendor="jjv"):global.JSONFormValidator&&(validator=global.JSONFormValidator.createEnvironment("json-schema-draft-03"),validator._vendor="jsv"):validator=options.validate,validator)if($(this.domRoot).jsonFormErrors(!1,options),"jjv"==validator._vendor){var v=validator.validate(this.formDesc._originalSchema,values);v&&(errors=[v])}else{var v=validator.validate(values,this.formDesc._originalSchema);"z-schema"==validator._vendor?(errors=validator.getLastErrors(),v=v?null:{errors:errors}):v&&v.errors&&v.errors.length&&(errors||(errors=[]),errors=errors.concat(v.errors))}}return errors&&!noErrorDisplay&&(options.displayErrors?options.displayErrors(errors,this.domRoot):$(this.domRoot).jsonFormErrors(errors,options)),{errors:errors,values:values}},formTree.prototype.submit=function(evt){var stopEvent=function(){return evt&&(evt.preventDefault(),evt.stopPropagation()),!1},values=jsonform.getFormValue(this.domRoot),options=this.formDesc,brk=!1;if(this.forEachElement(function(elt){brk||elt.view.onSubmit&&(brk=!elt.view.onSubmit(evt,elt))}),brk)return stopEvent();var validated=this.validate();return options.onSubmit&&!options.onSubmit(validated.errors,values)?stopEvent():validated.errors?stopEvent():!(!options.onSubmitValid||options.onSubmitValid(values))&&stopEvent()},formTree.prototype.hasRequiredField=function(){return $(this.domRoot).find(".jsonform-required").length>0},jsonform.getFormValue=function(formelt){var form=$(formelt).data("jsonform-tree");return form?form.root.getFormValues():null},$.fn.jsonFormErrors=function(errors,options){var form=$(this).data("jsonform-tree");if($("."+form.defaultClasses.groupMarkClassPrefix+"error",this).removeClass(form.defaultClasses.groupMarkClassPrefix+"error"),$("."+form.defaultClasses.groupMarkClassPrefix+"warning",this).removeClass(form.defaultClasses.groupMarkClassPrefix+"warning"),$(".jsonform-errortext",this).hide(),errors){for(var errorSelectors=[],i=0;i<errors.length;i++){var key=errors[i].uri||errors[i].path;if(["OBJECT_DEPENDENCY_KEY","OBJECT_MISSING_REQUIRED_PROPERTY"].indexOf(errors[i].code)>=0&&("/"!=key.slice(-1)&&(key+="/"),key+=errors[i].params[0]),key){key=key.replace(/.*#\//,"").replace(/\//g,".").replace(/\.([0-9]+)(?=\.|$)/g,"[$1]");var errormarkerclass=".jsonform-error-"+escapeSelector(key.replace(/\./g,"---"));errorSelectors.push(errormarkerclass);var errorType=errors[i].type||"error",$node=$(errormarkerclass,this);"ARRAY_LENGTH_SHORT"==errors[i].code&&["checkboxes","checkboxbuttons"].indexOf($node.data("jsonform-type"))>=0&&(errors[i].message="Please select at least "+errors[i].params[1]+(errors[i].params[1]>1?" options":" option")+" above."),$node.addClass(form.defaultClasses.groupMarkClassPrefix+errorType),$node.find("> div > .jsonform-errortext, > .jsonform-errortext").text(errors[i].message).show()}}errorSelectors=errorSelectors.join(",");var $errorSelectors=$(errorSelectors,this),$errorInvisiblePanels=$errorSelectors.parents(".tab-pane"),$errorTabs=$();$errorInvisiblePanels.each(function(){var $this=$(this);$errorTabs=$errorTabs.add($this.closest(".tabbable").find("> .nav > li").eq($this.index()).addClass(form.defaultClasses.groupMarkClassPrefix+"error"))});var firstError=$errorSelectors.filter(":visible").get(0);!firstError&&$errorTabs.length>0&&(firstError=$errorTabs.get(0)),firstError&&firstError.scrollIntoView&&firstError.scrollIntoView(!0,{behavior:"smooth"})}},$.fn.jsonForm=function(options,param1){if("values"===options)return jsonform.getFormValue(this);if("submit"===options){var form=this.data("jsonform-tree");return form?form.submit():null}if("validate"===options){var form=this.data("jsonform-tree");return form?form.validate(param1):null}var formElt=this;options=_.defaults({},options,{submitEvent:"submit"});var form=new formTree;return form.initialize(options),form.render(formElt.get(0)),options.transloadit&&formElt.append('<input type="hidden" name="params" value=\''+escapeHTML(JSON.stringify(options.transloadit.params))+"'>"),formElt.data("jsonform-tree",form),options.submitEvent&&(formElt.unbind(options.submitEvent+".jsonform"),formElt.bind(options.submitEvent+".jsonform",function(evt){form.submit(evt)})),initializeTabs(formElt),$(".expandable > div, .expandable > fieldset",formElt).hide(),formElt.on("click",".expandable > legend",function(){var parent=$(this).parent();parent.toggleClass("expanded"),$("> div",parent).slideToggle(100)}),form},$.fn.jsonFormValue=function(){return jsonform.getFormValue(this)},global.JSONForm||(global.JSONForm=jsonform)}("undefined"!=typeof exports,"undefined"!=typeof exports?exports:window,"undefined"!=typeof jQuery?jQuery:{fn:{}},"undefined"!=typeof _?_:null,JSON);